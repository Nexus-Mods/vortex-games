"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.installMixed = exports.testSupportedMixed = exports.installDLCMod = exports.testDLCMod = exports.installTL = exports.testSupportedTL = exports.installContent = exports.testSupportedContent = exports.installMenuMod = exports.testMenuModRoot = exports.scriptMergerDummyInstaller = exports.scriptMergerTest = void 0;
const path_1 = __importDefault(require("path"));
const common_1 = require("./common");
function scriptMergerTest(files, gameId) {
    const matcher = (file => common_1.SCRIPT_MERGER_FILES.includes(file));
    const supported = ((gameId === common_1.GAME_ID) && (files.filter(matcher).length > 0));
    return Promise.resolve({ supported, requiredFiles: common_1.SCRIPT_MERGER_FILES });
}
exports.scriptMergerTest = scriptMergerTest;
function scriptMergerDummyInstaller() {
    return (api) => {
        api.showErrorNotification('Invalid Mod', 'It looks like you tried to install '
            + 'The Witcher 3 Script Merger, which is a tool and not a mod for The Witcher 3.\n\n'
            + 'The script merger should\'ve been installed automatically by Vortex as soon as you activated this extension. '
            + 'If the download or installation has failed for any reason - please let us know why, by reporting the error through '
            + 'our feedback system and make sure to include vortex logs. Please note: if you\'ve installed '
            + 'the script merger in previous versions of Vortex as a mod and STILL have it installed '
            + '(it\'s present in your mod list) - you should consider un-installing it followed by a Vortex restart; '
            + 'the automatic merger installer/updater should then kick off and set up the tool for you.', { allowReport: false });
        return Promise.reject(new util.ProcessCanceled('Invalid mod'));
    };
}
exports.scriptMergerDummyInstaller = scriptMergerDummyInstaller;
function testMenuModRoot(instructions, gameId) {
    const hasMenuModPattern = (filePath) => [common_1.CONFIG_MATRIX_REL_PATH, common_1.PART_SUFFIX].some(pattern => filePath.toLowerCase().indexOf(pattern) !== -1);
    const predicate = (instr) => (!!gameId)
        ? ((common_1.GAME_ID === gameId) && (hasMenuModPattern(instr)))
        : ((instr.type === 'copy') && (hasMenuModPattern(instr.source)));
    return (!!gameId)
        ? Promise.resolve({
            supported: instructions.find(predicate) !== undefined,
            requiredFiles: [],
        })
        : Promise.resolve(instructions.find(predicate) !== undefined);
}
exports.testMenuModRoot = testMenuModRoot;
function installMenuMod(files, destinationPath) {
    var _a, _b, _c, _d;
    const filtered = files.filter(file => path_1.default.extname(path_1.default.basename(file)) !== '');
    const inputFiles = filtered.filter(file => file.indexOf(common_1.CONFIG_MATRIX_REL_PATH) !== -1);
    const uniqueInput = inputFiles.reduce((accum, iter) => {
        const fileName = path_1.default.basename(iter);
        if (accum.find(entry => path_1.default.basename(entry) === fileName) !== undefined) {
            return accum;
        }
        const instances = inputFiles.filter(file => path_1.default.basename(file) === fileName);
        if (instances.length > 1) {
            if (iter.toLowerCase().indexOf('backup') === -1) {
                accum.push(iter);
            }
        }
        else {
            accum.push(iter);
        }
        return accum;
    }, []);
    let otherFiles = filtered.filter(file => !inputFiles.includes(file));
    const inputFileDestination = common_1.CONFIG_MATRIX_REL_PATH;
    const binIdx = (_d = (_c = (_b = (_a = uniqueInput === null || uniqueInput === void 0 ? void 0 : uniqueInput[0]) === null || _a === void 0 ? void 0 : _a.toLowerCase()) === null || _b === void 0 ? void 0 : _b.split(path_1.default.sep)) === null || _c === void 0 ? void 0 : _c.indexOf) === null || _d === void 0 ? void 0 : _d.call(_c, 'bin');
    const modFiles = otherFiles.filter(file => file.toLowerCase().split(path_1.default.sep).includes('mods'));
    const modsIdx = (modFiles.length > 0)
        ? modFiles[0].toLowerCase().split(path_1.default.sep).indexOf('mods')
        : -1;
    const modNames = (modsIdx !== -1)
        ? modFiles.reduce((accum, iter) => {
            const modName = iter.split(path_1.default.sep).splice(modsIdx + 1, 1).join();
            if (!accum.includes(modName)) {
                accum.push(modName);
            }
            return accum;
        }, [])
        : [];
    if (modFiles.length > 0) {
        otherFiles = otherFiles.filter(file => !modFiles.includes(file));
    }
    const modName = (binIdx > 0)
        ? inputFiles[0].split(path_1.default.sep)[binIdx - 1]
        : ('mod' + path_1.default.basename(destinationPath, '.installing')).replace(/\s/g, '');
    const trimmedFiles = otherFiles.map(file => {
        const source = file;
        let relPath = file.split(path_1.default.sep)
            .slice(binIdx);
        if (relPath[0] === undefined) {
            relPath = file.split(path_1.default.sep);
        }
        const firstSeg = relPath[0].toLowerCase();
        if (firstSeg === 'content' || firstSeg.endsWith(common_1.PART_SUFFIX)) {
            relPath = [].concat(['Mods', modName], relPath);
        }
        return {
            source,
            relPath: relPath.join(path_1.default.sep),
        };
    });
    const toCopyInstruction = (source, destination) => ({
        type: 'copy',
        source,
        destination,
    });
    const inputInstructions = uniqueInput.map(file => toCopyInstruction(file, path_1.default.join(inputFileDestination, path_1.default.basename(file))));
    const otherInstructions = trimmedFiles.map(file => toCopyInstruction(file.source, file.relPath));
    const modFileInstructions = modFiles.map(file => toCopyInstruction(file, file));
    const instructions = [].concat(inputInstructions, otherInstructions, modFileInstructions);
    if (modNames.length > 0) {
        instructions.push({
            type: 'attribute',
            key: 'modComponents',
            value: modNames,
        });
    }
    return Promise.resolve({ instructions });
}
exports.installMenuMod = installMenuMod;
function testSupportedContent(files, gameId) {
    const supported = (gameId === common_1.GAME_ID)
        && (files.find(file => file.toLowerCase().startsWith('content' + path_1.default.sep) !== undefined));
    return Promise.resolve({
        supported,
        requiredFiles: [],
    });
}
exports.testSupportedContent = testSupportedContent;
function installContent(files, destinationPath) {
    return Promise.resolve(files
        .filter(file => file.toLowerCase().startsWith('content' + path_1.default.sep))
        .map(file => {
        const fileBase = file.split(path_1.default.sep).slice(1).join(path_1.default.sep);
        return {
            type: 'copy',
            source: file,
            destination: path_1.default.join('mod' + destinationPath, fileBase),
        };
    }));
}
exports.installContent = installContent;
function testSupportedTL(files, gameId) {
    const supported = (gameId === common_1.GAME_ID)
        && (files.find(file => file.toLowerCase().split(path_1.default.sep).indexOf('mods') !== -1) !== undefined);
    return Promise.resolve({
        supported,
        requiredFiles: [],
    });
}
exports.testSupportedTL = testSupportedTL;
function installTL(files) {
    let prefix = files.reduce((prev, file) => {
        const components = file.toLowerCase().split(path_1.default.sep);
        const idx = components.indexOf('mods');
        if ((idx > 0) && ((prev === undefined) || (idx < prev.length))) {
            return components.slice(0, idx) + path_1.default.sep;
        }
        else {
            return prev;
        }
    }, '');
    const instructions = files
        .filter(file => !file.endsWith(path_1.default.sep) && file.toLowerCase().startsWith(prefix))
        .map(file => ({
        type: 'copy',
        source: file,
        destination: file.slice(prefix.length),
    }));
    return Promise.resolve({ instructions });
}
exports.installTL = installTL;
function testDLCMod(files, gameId) {
    if (gameId !== common_1.GAME_ID) {
        return Promise.resolve({ supported: false, requiredFiles: [] });
    }
    const nonDlcFile = files.find(file => !file.toLowerCase().startsWith('dlc'));
    return (nonDlcFile !== undefined)
        ? Promise.resolve({ supported: false, requiredFiles: [] })
        : Promise.resolve({ supported: true, requiredFiles: [] });
}
exports.testDLCMod = testDLCMod;
function installDLCMod(files) {
    const modNames = [];
    const setModTypeInstr = {
        type: 'setmodtype',
        value: 'witcher3dlc',
    };
    const instructions = files.reduce((accum, iter) => {
        if (path_1.default.extname(iter) === '') {
            return accum;
        }
        const segments = iter.split(path_1.default.sep);
        const properlyFormatted = segments.length > 2
            ? (segments[0].toLowerCase() === 'dlc') && ((segments[2] || '').toLowerCase() === 'content')
            : false;
        const modName = properlyFormatted
            ? segments[1]
            : segments[0];
        modNames.push(modName);
        const destination = properlyFormatted
            ? segments.slice(1).join(path_1.default.sep)
            : segments.join(path_1.default.sep);
        accum.push({
            type: 'copy',
            source: iter,
            destination,
        });
        return accum;
    }, [setModTypeInstr]);
    const modNamesAttr = {
        type: 'attribute',
        key: 'modComponents',
        value: modNames,
    };
    instructions.push(modNamesAttr);
    return Promise.resolve({ instructions });
}
exports.installDLCMod = installDLCMod;
const hasPrefix = (prefix, fileEntry) => {
    const segments = fileEntry.toLowerCase().split(path_1.default.sep);
    const contentIdx = segments.indexOf('content');
    if ([-1, 0].includes(contentIdx)) {
        return false;
    }
    return segments[contentIdx - 1].indexOf(prefix) !== -1;
};
const isRootDirectory = (fileEntry) => {
    const segments = fileEntry.toLowerCase().split(path_1.default.sep);
    return (['mods', 'dlc'].includes(segments[0]));
};
function testSupportedMixed(files, gameId) {
    if (gameId !== common_1.GAME_ID) {
        return Promise.resolve({ supported: false, requiredFiles: [] });
    }
    const hasConfigMatrixFile = files.find(file => path_1.default.basename(file).toLowerCase() === common_1.CONFIG_MATRIX_REL_PATH) !== undefined;
    if (hasConfigMatrixFile) {
        return Promise.resolve({ supported: false, requiredFiles: [] });
    }
    const supported = (files.some(file => hasPrefix('dlc', file))) && (files.some(file => hasPrefix('mod', file)));
    return Promise.resolve({
        supported,
        requiredFiles: [],
    });
}
exports.testSupportedMixed = testSupportedMixed;
function installMixed(files) {
    const modNames = [];
    const instructions = files.reduce((accum, iter) => {
        const isRootDir = isRootDirectory(iter);
        const segments = iter.split(path_1.default.sep);
        if (!path_1.default.extname(segments[segments.length - 1])) {
            return accum;
        }
        let destinationSegments = [];
        const contentIdx = segments.map(seg => seg.toLowerCase()).indexOf('content');
        if (isRootDir) {
            segments.shift();
        }
        else if (contentIdx > 1) {
            segments.splice(contentIdx - 1);
        }
        if (hasPrefix('dlc', iter)) {
            destinationSegments = ['dlc'].concat(segments);
        }
        else if (hasPrefix('mod', iter)) {
            destinationSegments = ['mods'].concat(segments);
        }
        else {
            destinationSegments = iter.split(path_1.default.sep);
        }
        modNames.push(segments[0]);
        const instruction = {
            type: 'copy',
            source: iter,
            destination: destinationSegments.join(path_1.default.sep),
        };
        accum.push(instruction);
        return accum;
    }, []).concat([
        {
            type: 'attribute',
            key: 'modComponents',
            value: Array.from(new Set(modNames)),
        },
        {
            type: 'setmodtype',
            value: 'witcher3menumodroot',
        }
    ]);
    return Promise.resolve({ instructions });
}
exports.installMixed = installMixed;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5zdGFsbGVycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImluc3RhbGxlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ0EsZ0RBQXdCO0FBRXhCLHFDQUE2RjtBQUc3RixTQUFnQixnQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsTUFBTTtJQUM1QyxNQUFNLE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsNEJBQW1CLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDN0QsTUFBTSxTQUFTLEdBQUcsQ0FBQyxDQUFDLE1BQU0sS0FBSyxnQkFBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRS9FLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLFNBQVMsRUFBRSxhQUFhLEVBQUUsNEJBQW1CLEVBQUUsQ0FBQyxDQUFDO0FBQzVFLENBQUM7QUFMRCw0Q0FLQztBQUVELFNBQWdCLDBCQUEwQjtJQUN4QyxPQUFPLENBQUMsR0FBd0IsRUFBRSxFQUFFO1FBQ2xDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxhQUFhLEVBQUUscUNBQXFDO2NBQzFFLG1GQUFtRjtjQUNuRiwrR0FBK0c7Y0FDL0cscUhBQXFIO2NBQ3JILDhGQUE4RjtjQUM5Rix3RkFBd0Y7Y0FDeEYsd0dBQXdHO2NBQ3hHLDBGQUEwRixFQUM1RixFQUFFLFdBQVcsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQzFCLE9BQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxlQUFlLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztJQUNqRSxDQUFDLENBQUE7QUFDSCxDQUFDO0FBYkQsZ0VBYUM7QUFFRCxTQUFnQixlQUFlLENBQUMsWUFBbUIsRUFBRSxNQUFjO0lBRWpFLE1BQU0saUJBQWlCLEdBQUcsQ0FBQyxRQUFnQixF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LG1CQUFtQixDQUFDLElBQUksQ0FBQyxjQUFJLENBQUMsR0FBRyxDQUFDO1NBQ2hELENBQUM7UUFDRixLQUFLLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRXhCLE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUNaO1lBQ0UsSUFBSSxFQUFFLFdBQVc7WUFDakIsR0FBRyxFQUFFLGVBQWU7WUFDcEIsS0FBSyxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7U0FDckM7UUFDRDtZQUNFLElBQUksRUFBRSxZQUFZO1lBQ2xCLEtBQUssRUFBRSxxQkFBcUI7U0FDN0I7S0FDRixDQUFDLENBQUM7SUFDSCxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFDO0FBQzNDLENBQUM7QUFwREQsb0NBb0RDIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgKi9cclxuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XHJcbmltcG9ydCB7IHR5cGVzIH0gZnJvbSAndm9ydGV4LWFwaSc7XHJcbmltcG9ydCB7IENPTkZJR19NQVRSSVhfUkVMX1BBVEgsIEdBTUVfSUQsIFNDUklQVF9NRVJHRVJfRklMRVMsIFBBUlRfU1VGRklYIH0gZnJvbSAnLi9jb21tb24nO1xyXG5pbXBvcnQgeyBQcmVmaXhUeXBlIH0gZnJvbSAnLi90eXBlcyc7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gc2NyaXB0TWVyZ2VyVGVzdChmaWxlcywgZ2FtZUlkKSB7XHJcbiAgY29uc3QgbWF0Y2hlciA9IChmaWxlID0+IFNDUklQVF9NRVJHRVJfRklMRVMuaW5jbHVkZXMoZmlsZSkpO1xyXG4gIGNvbnN0IHN1cHBvcnRlZCA9ICgoZ2FtZUlkID09PSBHQU1FX0lEKSAmJiAoZmlsZXMuZmlsdGVyKG1hdGNoZXIpLmxlbmd0aCA+IDApKTtcclxuXHJcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN1cHBvcnRlZCwgcmVxdWlyZWRGaWxlczogU0NSSVBUX01FUkdFUl9GSUxFUyB9KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHNjcmlwdE1lcmdlckR1bW15SW5zdGFsbGVyKCkge1xyXG4gIHJldHVybiAoYXBpOiB0eXBlcy5JRXh0ZW5zaW9uQXBpKSA9PiB7XHJcbiAgICBhcGkuc2hvd0Vycm9yTm90aWZpY2F0aW9uKCdJbnZhbGlkIE1vZCcsICdJdCBsb29rcyBsaWtlIHlvdSB0cmllZCB0byBpbnN0YWxsICdcclxuICAgICAgKyAnVGhlIFdpdGNoZXIgMyBTY3JpcHQgTWVyZ2VyLCB3aGljaCBpcyBhIHRvb2wgYW5kIG5vdCBhIG1vZCBmb3IgVGhlIFdpdGNoZXIgMy5cXG5cXG4nXHJcbiAgICAgICsgJ1RoZSBzY3JpcHQgbWVyZ2VyIHNob3VsZFxcJ3ZlIGJlZW4gaW5zdGFsbGVkIGF1dG9tYXRpY2FsbHkgYnkgVm9ydGV4IGFzIHNvb24gYXMgeW91IGFjdGl2YXRlZCB0aGlzIGV4dGVuc2lvbi4gJ1xyXG4gICAgICArICdJZiB0aGUgZG93bmxvYWQgb3IgaW5zdGFsbGF0aW9uIGhhcyBmYWlsZWQgZm9yIGFueSByZWFzb24gLSBwbGVhc2UgbGV0IHVzIGtub3cgd2h5LCBieSByZXBvcnRpbmcgdGhlIGVycm9yIHRocm91Z2ggJ1xyXG4gICAgICArICdvdXIgZmVlZGJhY2sgc3lzdGVtIGFuZCBtYWtlIHN1cmUgdG8gaW5jbHVkZSB2b3J0ZXggbG9ncy4gUGxlYXNlIG5vdGU6IGlmIHlvdVxcJ3ZlIGluc3RhbGxlZCAnXHJcbiAgICAgICsgJ3RoZSBzY3JpcHQgbWVyZ2VyIGluIHByZXZpb3VzIHZlcnNpb25zIG9mIFZvcnRleCBhcyBhIG1vZCBhbmQgU1RJTEwgaGF2ZSBpdCBpbnN0YWxsZWQgJ1xyXG4gICAgICArICcoaXRcXCdzIHByZXNlbnQgaW4geW91ciBtb2QgbGlzdCkgLSB5b3Ugc2hvdWxkIGNvbnNpZGVyIHVuLWluc3RhbGxpbmcgaXQgZm9sbG93ZWQgYnkgYSBWb3J0ZXggcmVzdGFydDsgJ1xyXG4gICAgICArICd0aGUgYXV0b21hdGljIG1lcmdlciBpbnN0YWxsZXIvdXBkYXRlciBzaG91bGQgdGhlbiBraWNrIG9mZiBhbmQgc2V0IHVwIHRoZSB0b29sIGZvciB5b3UuJyxcclxuICAgICAgeyBhbGxvd1JlcG9ydDogZmFsc2UgfSk7XHJcbiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IHV0aWwuUHJvY2Vzc0NhbmNlbGVkKCdJbnZhbGlkIG1vZCcpKTtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB0ZXN0TWVudU1vZFJvb3QoaW5zdHJ1Y3Rpb25zOiBhbnlbXSwgZ2FtZUlkOiBzdHJpbmcpOiBQcm9taXNlPHR5cGVzLklTdXBwb3J0ZWRSZXN1bHQgfCBib29sZWFuPiB7XHJcbiAgLy8gVGhpcyBmdW5jdGlvbiBjYW4gdGVzdCBmb3IgYm90aCBpbnN0YWxsZXJzIGFuZCBtb2RUeXBlc1xyXG4gIGNvbnN0IGhhc01lbnVNb2RQYXR0ZXJuID0gKGZpbGVQYXRoOiBzdHJpbmcpID0+IFtDT05GSUdfTUFUUklYX1JFTF9QQVRILCBQQVJUX1NVRkZJWF0uc29tZShwYXR0ZXJuID0+XHJcbiAgICBmaWxlUGF0aC50b0xvd2VyQ2FzZSgpLmluZGV4T2YocGF0dGVybikgIT09IC0xKTtcclxuICBjb25zdCBwcmVkaWNhdGUgPSAoaW5zdHIpID0+ICghIWdhbWVJZClcclxuICAgID8gKChHQU1FX0lEID09PSBnYW1lSWQpICYmIChoYXNNZW51TW9kUGF0dGVybihpbnN0cikpKSAvLyBUZXN0IGZvciBpbnN0YWxsZXJcclxuICAgIDogKChpbnN0ci50eXBlID09PSAnY29weScpICYmIChoYXNNZW51TW9kUGF0dGVybihpbnN0ci5zb3VyY2UpKSk7IC8vIFRlc3QgZm9yIG1vZFR5cGVcclxuXHJcbiAgcmV0dXJuICghIWdhbWVJZClcclxuICAgID8gUHJvbWlzZS5yZXNvbHZlKHtcclxuICAgICAgc3VwcG9ydGVkOiBpbnN0cnVjdGlvbnMuZmluZChwcmVkaWNhdGUpICE9PSB1bmRlZmluZWQsXHJcbiAgICAgIHJlcXVpcmVkRmlsZXM6IFtdLFxyXG4gICAgfSlcclxuICAgIDogUHJvbWlzZS5yZXNvbHZlKGluc3RydWN0aW9ucy5maW5kKHByZWRpY2F0ZSkgIT09IHVuZGVmaW5lZCk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpbnN0YWxsTWVudU1vZChmaWxlczogc3RyaW5nW10sIGRlc3RpbmF0aW9uUGF0aDogc3RyaW5nKSB7XHJcbiAgLy8gSW5wdXQgc3BlY2lmaWMgZmlsZXMgbmVlZCB0byBiZSBpbnN0YWxsZWQgb3V0c2lkZSB0aGUgbW9kcyBmb2xkZXIgd2hpbGVcclxuICAvLyAgYWxsIG90aGVyIG1vZCBmaWxlcyBhcmUgdG8gYmUgaW5zdGFsbGVkIGFzIHVzdWFsLlxyXG4gIGNvbnN0IGZpbHRlcmVkID0gZmlsZXMuZmlsdGVyKGZpbGUgPT4gcGF0aC5leHRuYW1lKHBhdGguYmFzZW5hbWUoZmlsZSkpICE9PSAnJyk7XHJcbiAgY29uc3QgaW5wdXRGaWxlcyA9IGZpbHRlcmVkLmZpbHRlcihmaWxlID0+IGZpbGUuaW5kZXhPZihDT05GSUdfTUFUUklYX1JFTF9QQVRIKSAhPT0gLTEpO1xyXG4gIGNvbnN0IHVuaXF1ZUlucHV0ID0gaW5wdXRGaWxlcy5yZWR1Y2UoKGFjY3VtLCBpdGVyKSA9PiB7XHJcbiAgICAvLyBTb21lIG1vZHMgdGVuZCB0byBpbmNsdWRlIGEgYmFja3VwIGZpbGUgbWVhbnQgZm9yIHRoZSB1c2VyIHRvIHJlc3RvcmVcclxuICAgIC8vICBoaXMgZ2FtZSB0byB2YW5pbGxhIChvYnZzIHdlIG9ubHkgd2FudCB0byBhcHBseSB0aGUgbm9uLWJhY2t1cCkuXHJcbiAgICBjb25zdCBmaWxlTmFtZSA9IHBhdGguYmFzZW5hbWUoaXRlcik7XHJcblxyXG4gICAgaWYgKGFjY3VtLmZpbmQoZW50cnkgPT4gcGF0aC5iYXNlbmFtZShlbnRyeSkgPT09IGZpbGVOYW1lKSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIC8vIFRoaXMgY29uZmlnIGZpbGUgaGFzIGFscmVhZHkgYmVlbiBhZGRlZCB0byB0aGUgYWNjdW11bGF0b3IuXHJcbiAgICAgIC8vICBJZ25vcmUgdGhpcyBpbnN0YW5jZS5cclxuICAgICAgcmV0dXJuIGFjY3VtO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGluc3RhbmNlcyA9IGlucHV0RmlsZXMuZmlsdGVyKGZpbGUgPT4gcGF0aC5iYXNlbmFtZShmaWxlKSA9PT0gZmlsZU5hbWUpO1xyXG4gICAgaWYgKGluc3RhbmNlcy5sZW5ndGggPiAxKSB7XHJcbiAgICAgIC8vIFdlIGhhdmUgbXVsdGlwbGUgaW5zdGFuY2VzIG9mIHRoZSBzYW1lIG1lbnUgY29uZmlnIGZpbGUgLSBtb2QgYXV0aG9yIHByb2JhYmx5IGluY2x1ZGVkXHJcbiAgICAgIC8vICBhIGJhY2t1cCBmaWxlIHRvIHJlc3RvcmUgdmFuaWxsYSBzdGF0ZSwgb3IgcGVyaGFwcyB0aGlzIGlzIGEgdmFyaWFudCBtb2Qgd2hpY2ggd2VcclxuICAgICAgLy8gIGNhbid0IGN1cnJlbnRseSBzdXBwb3J0LlxyXG4gICAgICAvLyBJdCdzIGRpZmZpY3VsdCBmb3IgdXMgdG8gY29ycmVjdGx5IGlkZW50aWZ5IHRoZSBjb3JyZWN0IGZpbGUgYnV0IHdlJ3JlIGdvaW5nIHRvXHJcbiAgICAgIC8vICB0cnkgYW5kIGd1ZXNzIGJhc2VkIG9uIHdoZXRoZXIgdGhlIGNvbmZpZyBmaWxlIGhhcyBhIFwiYmFja3VwXCIgZm9sZGVyIHNlZ21lbnRcclxuICAgICAgLy8gIG90aGVyd2lzZSB3ZSBqdXN0IGFkZCB0aGUgZmlyc3QgZmlsZSBpbnN0YW5jZSAoSSdtIGdvaW5nIHRvIHJlZ3JldCBhZGRpbmcgdGhpcyBhcmVuJ3QgSSA/KVxyXG4gICAgICBpZiAoaXRlci50b0xvd2VyQ2FzZSgpLmluZGV4T2YoJ2JhY2t1cCcpID09PSAtMSkge1xyXG4gICAgICAgIC8vIFdlJ3JlIGdvaW5nIHRvIGFzc3VtZSB0aGF0IHRoaXMgaXMgdGhlIHJpZ2h0IGZpbGUuXHJcbiAgICAgICAgYWNjdW0ucHVzaChpdGVyKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8gVGhpcyBpcyBhIHVuaXF1ZSBtZW51IGNvbmZpZ3VyYXRpb24gZmlsZSAtIGFkZCBpdC5cclxuICAgICAgYWNjdW0ucHVzaChpdGVyKTtcclxuICAgIH1cclxuICAgIHJldHVybiBhY2N1bTtcclxuICB9LCBbXSk7XHJcblxyXG4gIGxldCBvdGhlckZpbGVzID0gZmlsdGVyZWQuZmlsdGVyKGZpbGUgPT4gIWlucHV0RmlsZXMuaW5jbHVkZXMoZmlsZSkpO1xyXG4gIGNvbnN0IGlucHV0RmlsZURlc3RpbmF0aW9uID0gQ09ORklHX01BVFJJWF9SRUxfUEFUSDtcclxuXHJcbiAgLy8gR2V0IHRoZSBtb2QncyByb290IGZvbGRlci5cclxuICBjb25zdCBiaW5JZHggPSB1bmlxdWVJbnB1dD8uWzBdPy50b0xvd2VyQ2FzZSgpPy5zcGxpdChwYXRoLnNlcCk/LmluZGV4T2Y/LignYmluJyk7XHJcblxyXG4gIC8vIFJlZmVycyB0byBmaWxlcyBsb2NhdGVkIGluc2lkZSB0aGUgYXJjaGl2ZSdzICdNb2RzJyBkaXJlY3RvcnkuXHJcbiAgLy8gIFRoaXMgYXJyYXkgY2FuIHZlcnkgd2VsbCBiZSBlbXB0eSBpZiBhIG1vZHMgZm9sZGVyIGRvZXNuJ3QgZXhpc3RcclxuICBjb25zdCBtb2RGaWxlcyA9IG90aGVyRmlsZXMuZmlsdGVyKGZpbGUgPT5cclxuICAgIGZpbGUudG9Mb3dlckNhc2UoKS5zcGxpdChwYXRoLnNlcCkuaW5jbHVkZXMoJ21vZHMnKSk7XHJcblxyXG4gIGNvbnN0IG1vZHNJZHggPSAobW9kRmlsZXMubGVuZ3RoID4gMClcclxuICAgID8gbW9kRmlsZXNbMF0udG9Mb3dlckNhc2UoKS5zcGxpdChwYXRoLnNlcCkuaW5kZXhPZignbW9kcycpXHJcbiAgICA6IC0xO1xyXG4gIGNvbnN0IG1vZE5hbWVzID0gKG1vZHNJZHggIT09IC0xKVxyXG4gICAgPyBtb2RGaWxlcy5yZWR1Y2UoKGFjY3VtLCBpdGVyKSA9PiB7XHJcbiAgICAgIGNvbnN0IG1vZE5hbWUgPSBpdGVyLnNwbGl0KHBhdGguc2VwKS5zcGxpY2UobW9kc0lkeCArIDEsIDEpLmpvaW4oKTtcclxuICAgICAgaWYgKCFhY2N1bS5pbmNsdWRlcyhtb2ROYW1lKSkge1xyXG4gICAgICAgIGFjY3VtLnB1c2gobW9kTmFtZSk7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIGFjY3VtO1xyXG4gICAgfSwgW10pXHJcbiAgICA6IFtdO1xyXG4gIC8vIFRoZSBwcmVzZW5jZSBvZiBhIG1vZHMgZm9sZGVyIGluZGljYXRlcyB0aGF0IHRoaXMgbW9kIG1heSBwcm92aWRlXHJcbiAgLy8gIHNldmVyYWwgbW9kIGVudHJpZXMuXHJcbiAgaWYgKG1vZEZpbGVzLmxlbmd0aCA+IDApIHtcclxuICAgIG90aGVyRmlsZXMgPSBvdGhlckZpbGVzLmZpbHRlcihmaWxlID0+ICFtb2RGaWxlcy5pbmNsdWRlcyhmaWxlKSk7XHJcbiAgfVxyXG5cclxuICAvLyBXZSdyZSBob3BpbmcgdGhhdCB0aGUgbW9kIGF1dGhvciBoYXMgaW5jbHVkZWQgdGhlIG1vZCBuYW1lIGluIHRoZSBhcmNoaXZlJ3NcclxuICAvLyAgc3RydWN0dXJlIC0gaWYgaGUgZGlkbid0IC0gd2UncmUgZ29pbmcgdG8gdXNlIHRoZSBkZXN0aW5hdGlvbiBwYXRoIGluc3RlYWQuXHJcbiAgY29uc3QgbW9kTmFtZSA9IChiaW5JZHggPiAwKVxyXG4gICAgPyBpbnB1dEZpbGVzWzBdLnNwbGl0KHBhdGguc2VwKVtiaW5JZHggLSAxXVxyXG4gICAgOiAoJ21vZCcgKyBwYXRoLmJhc2VuYW1lKGRlc3RpbmF0aW9uUGF0aCwgJy5pbnN0YWxsaW5nJykpLnJlcGxhY2UoL1xccy9nLCAnJyk7XHJcblxyXG4gIGNvbnN0IHRyaW1tZWRGaWxlcyA9IG90aGVyRmlsZXMubWFwKGZpbGUgPT4ge1xyXG4gICAgY29uc3Qgc291cmNlID0gZmlsZTtcclxuICAgIGxldCByZWxQYXRoID0gZmlsZS5zcGxpdChwYXRoLnNlcClcclxuICAgICAgLnNsaWNlKGJpbklkeCk7XHJcbiAgICBpZiAocmVsUGF0aFswXSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIC8vIFRoaXMgZmlsZSBtdXN0J3ZlIGJlZW4gaW5zaWRlIHRoZSByb290IG9mIHRoZSBhcmNoaXZlO1xyXG4gICAgICAvLyAgZGVwbG95IGFzIGlzLlxyXG4gICAgICByZWxQYXRoID0gZmlsZS5zcGxpdChwYXRoLnNlcCk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZmlyc3RTZWcgPSByZWxQYXRoWzBdLnRvTG93ZXJDYXNlKCk7XHJcbiAgICBpZiAoZmlyc3RTZWcgPT09ICdjb250ZW50JyB8fCBmaXJzdFNlZy5lbmRzV2l0aChQQVJUX1NVRkZJWCkpIHtcclxuICAgICAgcmVsUGF0aCA9IFtdLmNvbmNhdChbJ01vZHMnLCBtb2ROYW1lXSwgcmVsUGF0aCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgc291cmNlLFxyXG4gICAgICByZWxQYXRoOiByZWxQYXRoLmpvaW4ocGF0aC5zZXApLFxyXG4gICAgfTtcclxuICB9KTtcclxuXHJcbiAgY29uc3QgdG9Db3B5SW5zdHJ1Y3Rpb24gPSAoc291cmNlLCBkZXN0aW5hdGlvbikgPT4gKHtcclxuICAgIHR5cGU6ICdjb3B5JyxcclxuICAgIHNvdXJjZSxcclxuICAgIGRlc3RpbmF0aW9uLFxyXG4gIH0pO1xyXG5cclxuICBjb25zdCBpbnB1dEluc3RydWN0aW9ucyA9IHVuaXF1ZUlucHV0Lm1hcChmaWxlID0+XHJcbiAgICB0b0NvcHlJbnN0cnVjdGlvbihmaWxlLCBwYXRoLmpvaW4oaW5wdXRGaWxlRGVzdGluYXRpb24sIHBhdGguYmFzZW5hbWUoZmlsZSkpKSk7XHJcblxyXG4gIGNvbnN0IG90aGVySW5zdHJ1Y3Rpb25zID0gdHJpbW1lZEZpbGVzLm1hcChmaWxlID0+XHJcbiAgICB0b0NvcHlJbnN0cnVjdGlvbihmaWxlLnNvdXJjZSwgZmlsZS5yZWxQYXRoKSk7XHJcblxyXG4gIGNvbnN0IG1vZEZpbGVJbnN0cnVjdGlvbnMgPSBtb2RGaWxlcy5tYXAoZmlsZSA9PlxyXG4gICAgdG9Db3B5SW5zdHJ1Y3Rpb24oZmlsZSwgZmlsZSkpO1xyXG5cclxuICBjb25zdCBpbnN0cnVjdGlvbnMgPSBbXS5jb25jYXQoaW5wdXRJbnN0cnVjdGlvbnMsIG90aGVySW5zdHJ1Y3Rpb25zLCBtb2RGaWxlSW5zdHJ1Y3Rpb25zKTtcclxuICBpZiAobW9kTmFtZXMubGVuZ3RoID4gMCkge1xyXG4gICAgaW5zdHJ1Y3Rpb25zLnB1c2goe1xyXG4gICAgICB0eXBlOiAnYXR0cmlidXRlJyxcclxuICAgICAga2V5OiAnbW9kQ29tcG9uZW50cycsXHJcbiAgICAgIHZhbHVlOiBtb2ROYW1lcyxcclxuICAgIH0pO1xyXG4gIH1cclxuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgaW5zdHJ1Y3Rpb25zIH0pO1xyXG59XHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHRlc3RTdXBwb3J0ZWRDb250ZW50KGZpbGVzOiBzdHJpbmdbXSwgZ2FtZUlkOiBzdHJpbmcpIHtcclxuICBjb25zdCBzdXBwb3J0ZWQgPSAoZ2FtZUlkID09PSBHQU1FX0lEKVxyXG4gICAgJiYgKGZpbGVzLmZpbmQoZmlsZSA9PiBmaWxlLnRvTG93ZXJDYXNlKCkuc3RhcnRzV2l0aCgnY29udGVudCcgKyBwYXRoLnNlcCkgIT09IHVuZGVmaW5lZCkpO1xyXG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUoe1xyXG4gICAgc3VwcG9ydGVkLFxyXG4gICAgcmVxdWlyZWRGaWxlczogW10sXHJcbiAgfSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpbnN0YWxsQ29udGVudChmaWxlczogc3RyaW5nW10sIGRlc3RpbmF0aW9uUGF0aDogc3RyaW5nKSB7XHJcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmaWxlc1xyXG4gICAgLmZpbHRlcihmaWxlID0+IGZpbGUudG9Mb3dlckNhc2UoKS5zdGFydHNXaXRoKCdjb250ZW50JyArIHBhdGguc2VwKSlcclxuICAgIC5tYXAoZmlsZSA9PiB7XHJcbiAgICAgIGNvbnN0IGZpbGVCYXNlID0gZmlsZS5zcGxpdChwYXRoLnNlcCkuc2xpY2UoMSkuam9pbihwYXRoLnNlcCk7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgdHlwZTogJ2NvcHknLFxyXG4gICAgICAgIHNvdXJjZTogZmlsZSxcclxuICAgICAgICBkZXN0aW5hdGlvbjogcGF0aC5qb2luKCdtb2QnICsgZGVzdGluYXRpb25QYXRoLCBmaWxlQmFzZSksXHJcbiAgICAgIH07XHJcbiAgICB9KSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB0ZXN0U3VwcG9ydGVkVEwoZmlsZXM6IHN0cmluZ1tdLCBnYW1lSWQ6IHN0cmluZykge1xyXG4gIGNvbnN0IHN1cHBvcnRlZCA9IChnYW1lSWQgPT09IEdBTUVfSUQpXHJcbiAgICAmJiAoZmlsZXMuZmluZChmaWxlID0+XHJcbiAgICAgIGZpbGUudG9Mb3dlckNhc2UoKS5zcGxpdChwYXRoLnNlcCkuaW5kZXhPZignbW9kcycpICE9PSAtMSkgIT09IHVuZGVmaW5lZCk7XHJcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XHJcbiAgICBzdXBwb3J0ZWQsXHJcbiAgICByZXF1aXJlZEZpbGVzOiBbXSxcclxuICB9KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGluc3RhbGxUTChmaWxlczogc3RyaW5nW10pIHtcclxuICBsZXQgcHJlZml4ID0gZmlsZXMucmVkdWNlKChwcmV2LCBmaWxlKSA9PiB7XHJcbiAgICBjb25zdCBjb21wb25lbnRzOiBzdHJpbmdbXSA9IGZpbGUudG9Mb3dlckNhc2UoKS5zcGxpdChwYXRoLnNlcCk7XHJcbiAgICBjb25zdCBpZHggPSBjb21wb25lbnRzLmluZGV4T2YoJ21vZHMnKTtcclxuICAgIGlmICgoaWR4ID4gMCkgJiYgKChwcmV2ID09PSB1bmRlZmluZWQpIHx8IChpZHggPCBwcmV2Lmxlbmd0aCkpKSB7XHJcbiAgICAgIHJldHVybiBjb21wb25lbnRzLnNsaWNlKDAsIGlkeCkgKyBwYXRoLnNlcDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBwcmV2O1xyXG4gICAgfVxyXG4gIH0sICcnKTtcclxuXHJcbiAgY29uc3QgaW5zdHJ1Y3Rpb25zID0gZmlsZXNcclxuICAgIC5maWx0ZXIoZmlsZSA9PiAhZmlsZS5lbmRzV2l0aChwYXRoLnNlcCkgJiYgZmlsZS50b0xvd2VyQ2FzZSgpLnN0YXJ0c1dpdGgocHJlZml4KSlcclxuICAgIC5tYXAoZmlsZSA9PiAoe1xyXG4gICAgICB0eXBlOiAnY29weScsXHJcbiAgICAgIHNvdXJjZTogZmlsZSxcclxuICAgICAgZGVzdGluYXRpb246IGZpbGUuc2xpY2UocHJlZml4Lmxlbmd0aCksXHJcbiAgICB9KSk7XHJcblxyXG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBpbnN0cnVjdGlvbnMgfSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB0ZXN0RExDTW9kKGZpbGVzOiBzdHJpbmdbXSwgZ2FtZUlkOiBzdHJpbmcpOiBQcm9taXNlPHR5cGVzLklTdXBwb3J0ZWRSZXN1bHQ+IHtcclxuICBpZiAoZ2FtZUlkICE9PSBHQU1FX0lEKSB7XHJcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3VwcG9ydGVkOiBmYWxzZSwgcmVxdWlyZWRGaWxlczogW10gfSk7XHJcbiAgfVxyXG5cclxuICBjb25zdCBub25EbGNGaWxlID0gZmlsZXMuZmluZChmaWxlID0+ICFmaWxlLnRvTG93ZXJDYXNlKCkuc3RhcnRzV2l0aCgnZGxjJykpO1xyXG4gIHJldHVybiAobm9uRGxjRmlsZSAhPT0gdW5kZWZpbmVkKVxyXG4gICAgPyBQcm9taXNlLnJlc29sdmUoeyBzdXBwb3J0ZWQ6IGZhbHNlLCByZXF1aXJlZEZpbGVzOiBbXSB9KVxyXG4gICAgOiBQcm9taXNlLnJlc29sdmUoeyBzdXBwb3J0ZWQ6IHRydWUsIHJlcXVpcmVkRmlsZXM6IFtdIH0pO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaW5zdGFsbERMQ01vZChmaWxlczogc3RyaW5nW10pIHtcclxuICBjb25zdCBtb2ROYW1lcyA9IFtdO1xyXG4gIGNvbnN0IHNldE1vZFR5cGVJbnN0cjogdHlwZXMuSUluc3RydWN0aW9uID0ge1xyXG4gICAgdHlwZTogJ3NldG1vZHR5cGUnLFxyXG4gICAgdmFsdWU6ICd3aXRjaGVyM2RsYycsXHJcbiAgfTtcclxuICBjb25zdCBpbnN0cnVjdGlvbnM6IHR5cGVzLklJbnN0cnVjdGlvbltdID0gZmlsZXMucmVkdWNlKChhY2N1bSwgaXRlcikgPT4ge1xyXG4gICAgaWYgKHBhdGguZXh0bmFtZShpdGVyKSA9PT0gJycpIHtcclxuICAgICAgcmV0dXJuIGFjY3VtO1xyXG4gICAgfVxyXG4gICAgY29uc3Qgc2VnbWVudHMgPSBpdGVyLnNwbGl0KHBhdGguc2VwKTtcclxuICAgIGNvbnN0IHByb3Blcmx5Rm9ybWF0dGVkID0gc2VnbWVudHMubGVuZ3RoID4gMlxyXG4gICAgICA/IChzZWdtZW50c1swXS50b0xvd2VyQ2FzZSgpID09PSAnZGxjJykgJiYgKChzZWdtZW50c1syXSB8fCAnJykudG9Mb3dlckNhc2UoKSA9PT0gJ2NvbnRlbnQnKVxyXG4gICAgICA6IGZhbHNlO1xyXG4gICAgY29uc3QgbW9kTmFtZSA9IHByb3Blcmx5Rm9ybWF0dGVkXHJcbiAgICAgID8gc2VnbWVudHNbMV1cclxuICAgICAgOiBzZWdtZW50c1swXTtcclxuICAgIG1vZE5hbWVzLnB1c2gobW9kTmFtZSk7XHJcbiAgICBjb25zdCBkZXN0aW5hdGlvbiA9IHByb3Blcmx5Rm9ybWF0dGVkXHJcbiAgICAgID8gc2VnbWVudHMuc2xpY2UoMSkuam9pbihwYXRoLnNlcClcclxuICAgICAgOiBzZWdtZW50cy5qb2luKHBhdGguc2VwKTtcclxuICAgIGFjY3VtLnB1c2goe1xyXG4gICAgICB0eXBlOiAnY29weScsXHJcbiAgICAgIHNvdXJjZTogaXRlcixcclxuICAgICAgZGVzdGluYXRpb24sXHJcbiAgICB9KVxyXG4gICAgcmV0dXJuIGFjY3VtO1xyXG4gIH0sIFtzZXRNb2RUeXBlSW5zdHJdKTtcclxuXHJcbiAgY29uc3QgbW9kTmFtZXNBdHRyOiB0eXBlcy5JSW5zdHJ1Y3Rpb24gPSB7XHJcbiAgICB0eXBlOiAnYXR0cmlidXRlJyxcclxuICAgIGtleTogJ21vZENvbXBvbmVudHMnLFxyXG4gICAgdmFsdWU6IG1vZE5hbWVzLFxyXG4gIH07XHJcbiAgaW5zdHJ1Y3Rpb25zLnB1c2gobW9kTmFtZXNBdHRyKTtcclxuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgaW5zdHJ1Y3Rpb25zIH0pO1xyXG59XHJcblxyXG5jb25zdCBoYXNQcmVmaXggPSAocHJlZml4OiBQcmVmaXhUeXBlLCBmaWxlRW50cnk6IHN0cmluZykgPT4ge1xyXG4gIGNvbnN0IHNlZ21lbnRzID0gZmlsZUVudHJ5LnRvTG93ZXJDYXNlKCkuc3BsaXQocGF0aC5zZXApO1xyXG4gIGNvbnN0IGNvbnRlbnRJZHggPSBzZWdtZW50cy5pbmRleE9mKCdjb250ZW50Jyk7XHJcbiAgaWYgKFstMSwgMF0uaW5jbHVkZXMoY29udGVudElkeCkpIHtcclxuICAgIC8vIE5vIGNvbnRlbnQgZm9sZGVyLCBubyBtb2QuXHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gc2VnbWVudHNbY29udGVudElkeCAtIDFdLmluZGV4T2YocHJlZml4KSAhPT0gLTE7XHJcbn07XHJcblxyXG5jb25zdCBpc1Jvb3REaXJlY3RvcnkgPSAoZmlsZUVudHJ5OiBzdHJpbmcpID0+IHtcclxuICBjb25zdCBzZWdtZW50cyA9IGZpbGVFbnRyeS50b0xvd2VyQ2FzZSgpLnNwbGl0KHBhdGguc2VwKTtcclxuICByZXR1cm4gKFsnbW9kcycsICdkbGMnXS5pbmNsdWRlcyhzZWdtZW50c1swXSkpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdGVzdFN1cHBvcnRlZE1peGVkKGZpbGVzOiBzdHJpbmdbXSwgZ2FtZUlkOiBzdHJpbmcpOiBQcm9taXNlPHR5cGVzLklTdXBwb3J0ZWRSZXN1bHQ+IHtcclxuICBpZiAoZ2FtZUlkICE9PSBHQU1FX0lEKSB7XHJcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3VwcG9ydGVkOiBmYWxzZSwgcmVxdWlyZWRGaWxlczogW10gfSk7XHJcbiAgfVxyXG5cclxuICBjb25zdCBoYXNDb25maWdNYXRyaXhGaWxlID0gZmlsZXMuZmluZChmaWxlID0+XHJcbiAgICBwYXRoLmJhc2VuYW1lKGZpbGUpLnRvTG93ZXJDYXNlKCkgPT09IENPTkZJR19NQVRSSVhfUkVMX1BBVEgpICE9PSB1bmRlZmluZWQ7XHJcbiAgaWYgKGhhc0NvbmZpZ01hdHJpeEZpbGUpIHtcclxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBzdXBwb3J0ZWQ6IGZhbHNlLCByZXF1aXJlZEZpbGVzOiBbXSB9KTtcclxuICB9XHJcblxyXG4gIGNvbnN0IHN1cHBvcnRlZCA9IChmaWxlcy5zb21lKGZpbGUgPT4gaGFzUHJlZml4KCdkbGMnLCBmaWxlKSkpICYmIChmaWxlcy5zb21lKGZpbGUgPT4gaGFzUHJlZml4KCdtb2QnLCBmaWxlKSkpO1xyXG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUoe1xyXG4gICAgc3VwcG9ydGVkLFxyXG4gICAgcmVxdWlyZWRGaWxlczogW10sXHJcbiAgfSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpbnN0YWxsTWl4ZWQoZmlsZXM6IHN0cmluZ1tdKSB7XHJcbiAgLy8gV2UgY2FuIG9ubHkgYXNzdW1lIHRoYXQgZmlsZXMgd2l0aCB0aGUgJ2RsYycgcHJlZml4IGdvIGluc2lkZSBkbGMgYW5kIGZpbGVzXHJcbiAgLy8gIHdpdGggdGhlICdtb2QnIHByZWZpeCBnbyBpbnNpZGUgbW9kcy5cclxuICBjb25zdCBtb2ROYW1lczogc3RyaW5nW10gPSBbXTtcclxuICBjb25zdCBpbnN0cnVjdGlvbnM6IHR5cGVzLklJbnN0cnVjdGlvbltdID0gZmlsZXMucmVkdWNlKChhY2N1bSwgaXRlcikgPT4ge1xyXG4gICAgY29uc3QgaXNSb290RGlyID0gaXNSb290RGlyZWN0b3J5KGl0ZXIpO1xyXG4gICAgY29uc3Qgc2VnbWVudHMgPSBpdGVyLnNwbGl0KHBhdGguc2VwKTtcclxuICAgIGlmICghcGF0aC5leHRuYW1lKHNlZ21lbnRzW3NlZ21lbnRzLmxlbmd0aCAtIDFdKSkge1xyXG4gICAgICByZXR1cm4gYWNjdW07XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGRlc3RpbmF0aW9uU2VnbWVudHMgPSBbXTtcclxuICAgIGNvbnN0IGNvbnRlbnRJZHggPSBzZWdtZW50cy5tYXAoc2VnID0+IHNlZy50b0xvd2VyQ2FzZSgpKS5pbmRleE9mKCdjb250ZW50Jyk7XHJcblxyXG4gICAgaWYgKGlzUm9vdERpcikge1xyXG4gICAgICAvLyBUYWtlIG91dCB0aGUgcm9vdCBmb2xkZXIuXHJcbiAgICAgIHNlZ21lbnRzLnNoaWZ0KCk7XHJcbiAgICB9IGVsc2UgaWYgKGNvbnRlbnRJZHggPiAxKSB7XHJcbiAgICAgIC8vIFRha2Ugb3V0IGFueXRoaW5nIHByaW9yIHRvIHRoZSBtb2QgZm9sZGVyLlxyXG4gICAgICBzZWdtZW50cy5zcGxpY2UoY29udGVudElkeCAtIDEpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChoYXNQcmVmaXgoJ2RsYycsIGl0ZXIpKSB7XHJcbiAgICAgIGRlc3RpbmF0aW9uU2VnbWVudHMgPSBbJ2RsYyddLmNvbmNhdChzZWdtZW50cyk7XHJcbiAgICB9IGVsc2UgaWYgKGhhc1ByZWZpeCgnbW9kJywgaXRlcikpIHtcclxuICAgICAgZGVzdGluYXRpb25TZWdtZW50cyA9IFsnbW9kcyddLmNvbmNhdChzZWdtZW50cyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyBEb24ndCBrbm93LCBkb24ndCBjYXJlXHJcbiAgICAgIGRlc3RpbmF0aW9uU2VnbWVudHMgPSBpdGVyLnNwbGl0KHBhdGguc2VwKTtcclxuICAgIH1cclxuXHJcbiAgICBtb2ROYW1lcy5wdXNoKHNlZ21lbnRzWzBdKTtcclxuICAgIGNvbnN0IGluc3RydWN0aW9uOiB0eXBlcy5JSW5zdHJ1Y3Rpb24gPSB7XHJcbiAgICAgIHR5cGU6ICdjb3B5JyxcclxuICAgICAgc291cmNlOiBpdGVyLFxyXG4gICAgICBkZXN0aW5hdGlvbjogZGVzdGluYXRpb25TZWdtZW50cy5qb2luKHBhdGguc2VwKSxcclxuICAgIH07XHJcbiAgICBhY2N1bS5wdXNoKGluc3RydWN0aW9uKTtcclxuXHJcbiAgICByZXR1cm4gYWNjdW07XHJcbiAgfSwgW10pLmNvbmNhdChbXHJcbiAgICB7XHJcbiAgICAgIHR5cGU6ICdhdHRyaWJ1dGUnLFxyXG4gICAgICBrZXk6ICdtb2RDb21wb25lbnRzJyxcclxuICAgICAgdmFsdWU6IEFycmF5LmZyb20obmV3IFNldChtb2ROYW1lcykpLFxyXG4gICAgfSxcclxuICAgIHtcclxuICAgICAgdHlwZTogJ3NldG1vZHR5cGUnLFxyXG4gICAgICB2YWx1ZTogJ3dpdGNoZXIzbWVudW1vZHJvb3QnLFxyXG4gICAgfVxyXG4gIF0pO1xyXG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBpbnN0cnVjdGlvbnMgfSk7XHJcbn1cclxuIl19