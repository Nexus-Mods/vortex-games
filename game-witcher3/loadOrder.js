"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const react_1 = __importDefault(require("react"));
const vortex_api_1 = require("vortex-api");
const common_1 = require("./common");
const InfoComponent_1 = __importDefault(require("./views/InfoComponent"));
const iniParser_1 = __importDefault(require("./iniParser"));
;
class TW3LoadOrder {
    constructor(props) {
        this.readableNames = { [common_1.UNI_PATCH]: 'Unification/Community Patch' };
        this.gameId = common_1.GAME_ID;
        this.clearStateOnPurge = true;
        this.toggleableEntries = true;
        this.noCollectionGeneration = true;
        this.usageInstructions = () => (react_1.default.createElement(InfoComponent_1.default, { onToggleModsState: props.onToggleModsState }));
        this.mApi = props.api;
        this.mPriorityManager = props.priorityManager;
        this.deserializeLoadOrder = this.deserializeLoadOrder.bind(this);
        this.serializeLoadOrder = this.serializeLoadOrder.bind(this);
        this.validate = this.validate.bind(this);
    }
    serializeLoadOrder(loadOrder) {
        return __awaiter(this, void 0, void 0, function* () {
            yield iniParser_1.default.getInstance(this.mApi, this.mPriorityManager).setINIStruct(loadOrder, this.mPriorityManager);
            return iniParser_1.default.getInstance(this.mApi, this.mPriorityManager).writeToModSettings();
        });
    }
    deserializeLoadOrder() {
        return __awaiter(this, void 0, void 0, function* () {
            const state = this.mApi.getState();
            const activeProfile = vortex_api_1.selectors.activeProfile(state);
            if ((activeProfile === null || activeProfile === void 0 ? void 0 : activeProfile.id) === undefined) {
                return Promise.resolve([]);
            }
            const findName = (val) => { var _a; return ((_a = this.readableNames) === null || _a === void 0 ? void 0 : _a[val]) || val; };
            try {
                const ini = yield iniParser_1.default.getInstance(this.mApi, this.mPriorityManager).readStructure();
                const entries = Object.keys(ini.data)
                    .map((iter, idx) => {
                    var _a, _b, _c;
                    const entry = ini.data[iter];
                    return {
                        id: iter,
                        name: findName(iter),
                        enabled: entry.Enabled === 1,
                        modId: (_a = entry === null || entry === void 0 ? void 0 : entry.VK) !== null && _a !== void 0 ? _a : iter,
                        locked: iter.startsWith(common_1.LOCKED_PREFIX),
                        data: {
                            prefix: ((_c = (_b = ini.data) === null || _b === void 0 ? void 0 : _b[idx]) === null || _c === void 0 ? void 0 : _c.Priority) !== undefined ? +ini.data[idx].Priority : idx + 1,
                        }
                    };
                });
                return Promise.resolve(entries.sort((a, b) => b.data.prefix - a.data.prefix));
            }
            catch (err) {
                return;
            }
        });
    }
    validate(prev, current) {
        return __awaiter(this, void 0, void 0, function* () {
            return Promise.resolve(undefined);
        });
    }
}
exports.default = TW3LoadOrder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZE9yZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibG9hZE9yZGVyLnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUNBLGtEQUEwQjtBQUMxQiwyQ0FBOEM7QUFFOUMscUNBQTZEO0FBQzdELDBFQUFrRDtBQUNsRCw0REFBdUM7QUFPdEMsQ0FBQztBQUVGLE1BQU0sWUFBWTtJQVVoQixZQUFZLEtBQWlCO1FBa0JyQixrQkFBYSxHQUFHLEVBQUMsQ0FBQyxrQkFBUyxDQUFDLEVBQUUsNkJBQTZCLEVBQUMsQ0FBQztRQWpCbkUsSUFBSSxDQUFDLE1BQU0sR0FBRyxnQkFBTyxDQUFDO1FBQ3RCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUM7UUFDOUIsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksQ0FBQztRQUM5QixJQUFJLENBQUMsc0JBQXNCLEdBQUcsSUFBSSxDQUFDO1FBQ25DLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxHQUFHLEVBQUUsQ0FBQyxDQUFDLDhCQUFDLHVCQUFhLElBQUMsaUJBQWlCLEVBQUUsS0FBSyxDQUFDLGlCQUFpQixHQUFHLENBQUMsQ0FBQztRQUM5RixJQUFJLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUM7UUFDdEIsSUFBSSxDQUFDLGdCQUFnQixHQUFHLEtBQUssQ0FBQyxlQUFlLENBQUM7UUFDOUMsSUFBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDakUsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDN0QsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMzQyxDQUFDO0lBRVksa0JBQWtCLENBQUMsU0FBMEI7O1lBQ3hELE1BQU0sbUJBQVksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ2hILE9BQU8sbUJBQVksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1FBQ3pGLENBQUM7S0FBQTtJQUdZLG9CQUFvQjs7WUFDL0IsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNuQyxNQUFNLGFBQWEsR0FBRyxzQkFBUyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNyRCxJQUFJLENBQUEsYUFBYSxhQUFiLGFBQWEsdUJBQWIsYUFBYSxDQUFFLEVBQUUsTUFBSyxTQUFTLEVBQUU7Z0JBQ25DLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQzthQUM1QjtZQUNELE1BQU0sUUFBUSxHQUFHLENBQUMsR0FBVyxFQUFFLEVBQUUsV0FBQyxPQUFBLENBQUEsTUFBQSxJQUFJLENBQUMsYUFBYSwwQ0FBRyxHQUFHLENBQUMsS0FBSSxHQUFHLENBQUEsRUFBQSxDQUFDO1lBQ25FLElBQUk7Z0JBQ0YsTUFBTSxHQUFHLEdBQUcsTUFBTSxtQkFBWSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLGFBQWEsRUFBRSxDQUFDO2dCQUM3RixNQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUM7cUJBQ2xDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxHQUFHLEVBQXlCLEVBQUU7O29CQUN4QyxNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUM3QixPQUFPO3dCQUNMLEVBQUUsRUFBRSxJQUFJO3dCQUNSLElBQUksRUFBRSxRQUFRLENBQUMsSUFBSSxDQUFDO3dCQUNwQixPQUFPLEVBQUUsS0FBSyxDQUFDLE9BQU8sS0FBSyxDQUFDO3dCQUM1QixLQUFLLEVBQUUsTUFBQSxLQUFLLGFBQUwsS0FBSyx1QkFBTCxLQUFLLENBQUUsRUFBRSxtQ0FBSSxJQUFJO3dCQUN4QixNQUFNLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxzQkFBYSxDQUFDO3dCQUN0QyxJQUFJLEVBQUU7NEJBQ0osTUFBTSxFQUFFLENBQUEsTUFBQSxNQUFBLEdBQUcsQ0FBQyxJQUFJLDBDQUFHLEdBQUcsQ0FBQywwQ0FBRSxRQUFRLE1BQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQzt5QkFDcEY7cUJBQ0YsQ0FBQTtnQkFDSCxDQUFDLENBQUMsQ0FBQztnQkFDTCxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQzthQUM5RTtZQUFDLE9BQU8sR0FBRyxFQUFFO2dCQUNaLE9BQU07YUFDUDtRQThHSCxDQUFDO0tBQUE7SUFFWSxRQUFRLENBQUMsSUFBcUIsRUFBRSxPQUF3Qjs7WUFDbkUsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3BDLENBQUM7S0FBQTtDQUNGO0FBRUQsa0JBQWUsWUFBWSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgKi9cclxuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcclxuaW1wb3J0IHsgc2VsZWN0b3JzLCB0eXBlcyB9IGZyb20gJ3ZvcnRleC1hcGknO1xyXG5cclxuaW1wb3J0IHsgR0FNRV9JRCwgTE9DS0VEX1BSRUZJWCwgVU5JX1BBVENIIH0gZnJvbSAnLi9jb21tb24nO1xyXG5pbXBvcnQgSW5mb0NvbXBvbmVudCBmcm9tICcuL3ZpZXdzL0luZm9Db21wb25lbnQnO1xyXG5pbXBvcnQgSW5pU3RydWN0dXJlIGZyb20gJy4vaW5pUGFyc2VyJztcclxuaW1wb3J0IHsgUHJpb3JpdHlNYW5hZ2VyIH0gZnJvbSAnLi9wcmlvcml0eU1hbmFnZXInO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJQmFzZVByb3BzIHtcclxuICBhcGk6IHR5cGVzLklFeHRlbnNpb25BcGk7XHJcbiAgcHJpb3JpdHlNYW5hZ2VyOiBQcmlvcml0eU1hbmFnZXI7XHJcbiAgb25Ub2dnbGVNb2RzU3RhdGU6IChlbmFibGU6IGJvb2xlYW4pID0+IHZvaWQ7XHJcbn07XHJcblxyXG5jbGFzcyBUVzNMb2FkT3JkZXIgaW1wbGVtZW50cyB0eXBlcy5JTG9hZE9yZGVyR2FtZUluZm8ge1xyXG4gIHB1YmxpYyBnYW1lSWQ6IHN0cmluZztcclxuICBwdWJsaWMgdG9nZ2xlYWJsZUVudHJpZXM/OiBib29sZWFuIHwgdW5kZWZpbmVkO1xyXG4gIHB1YmxpYyBjbGVhclN0YXRlT25QdXJnZT86IGJvb2xlYW4gfCB1bmRlZmluZWQ7XHJcbiAgcHVibGljIHVzYWdlSW5zdHJ1Y3Rpb25zPzogUmVhY3QuQ29tcG9uZW50VHlwZTx7fT47XHJcbiAgcHVibGljIG5vQ29sbGVjdGlvbkdlbmVyYXRpb24/OiBib29sZWFuIHwgdW5kZWZpbmVkO1xyXG5cclxuICBwcml2YXRlIG1BcGk6IHR5cGVzLklFeHRlbnNpb25BcGk7XHJcbiAgcHJpdmF0ZSBtUHJpb3JpdHlNYW5hZ2VyOiBQcmlvcml0eU1hbmFnZXI7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByb3BzOiBJQmFzZVByb3BzKSB7XHJcbiAgICB0aGlzLmdhbWVJZCA9IEdBTUVfSUQ7XHJcbiAgICB0aGlzLmNsZWFyU3RhdGVPblB1cmdlID0gdHJ1ZTtcclxuICAgIHRoaXMudG9nZ2xlYWJsZUVudHJpZXMgPSB0cnVlO1xyXG4gICAgdGhpcy5ub0NvbGxlY3Rpb25HZW5lcmF0aW9uID0gdHJ1ZTtcclxuICAgIHRoaXMudXNhZ2VJbnN0cnVjdGlvbnMgPSAoKSA9PiAoPEluZm9Db21wb25lbnQgb25Ub2dnbGVNb2RzU3RhdGU9e3Byb3BzLm9uVG9nZ2xlTW9kc1N0YXRlfS8+KTtcclxuICAgIHRoaXMubUFwaSA9IHByb3BzLmFwaTtcclxuICAgIHRoaXMubVByaW9yaXR5TWFuYWdlciA9IHByb3BzLnByaW9yaXR5TWFuYWdlcjtcclxuICAgIHRoaXMuZGVzZXJpYWxpemVMb2FkT3JkZXIgPSB0aGlzLmRlc2VyaWFsaXplTG9hZE9yZGVyLmJpbmQodGhpcyk7XHJcbiAgICB0aGlzLnNlcmlhbGl6ZUxvYWRPcmRlciA9IHRoaXMuc2VyaWFsaXplTG9hZE9yZGVyLmJpbmQodGhpcyk7XHJcbiAgICB0aGlzLnZhbGlkYXRlID0gdGhpcy52YWxpZGF0ZS5iaW5kKHRoaXMpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIHNlcmlhbGl6ZUxvYWRPcmRlcihsb2FkT3JkZXI6IHR5cGVzLkxvYWRPcmRlcik6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgYXdhaXQgSW5pU3RydWN0dXJlLmdldEluc3RhbmNlKHRoaXMubUFwaSwgdGhpcy5tUHJpb3JpdHlNYW5hZ2VyKS5zZXRJTklTdHJ1Y3QobG9hZE9yZGVyLCB0aGlzLm1Qcmlvcml0eU1hbmFnZXIpO1xyXG4gICAgcmV0dXJuIEluaVN0cnVjdHVyZS5nZXRJbnN0YW5jZSh0aGlzLm1BcGksIHRoaXMubVByaW9yaXR5TWFuYWdlcikud3JpdGVUb01vZFNldHRpbmdzKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlYWRhYmxlTmFtZXMgPSB7W1VOSV9QQVRDSF06ICdVbmlmaWNhdGlvbi9Db21tdW5pdHkgUGF0Y2gnfTtcclxuICBwdWJsaWMgYXN5bmMgZGVzZXJpYWxpemVMb2FkT3JkZXIoKTogUHJvbWlzZTx0eXBlcy5Mb2FkT3JkZXI+IHtcclxuICAgIGNvbnN0IHN0YXRlID0gdGhpcy5tQXBpLmdldFN0YXRlKCk7XHJcbiAgICBjb25zdCBhY3RpdmVQcm9maWxlID0gc2VsZWN0b3JzLmFjdGl2ZVByb2ZpbGUoc3RhdGUpO1xyXG4gICAgaWYgKGFjdGl2ZVByb2ZpbGU/LmlkID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShbXSk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBmaW5kTmFtZSA9ICh2YWw6IHN0cmluZykgPT4gdGhpcy5yZWFkYWJsZU5hbWVzPy5bdmFsXSB8fCB2YWw7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBpbmkgPSBhd2FpdCBJbmlTdHJ1Y3R1cmUuZ2V0SW5zdGFuY2UodGhpcy5tQXBpLCB0aGlzLm1Qcmlvcml0eU1hbmFnZXIpLnJlYWRTdHJ1Y3R1cmUoKTtcclxuICAgICAgY29uc3QgZW50cmllcyA9IE9iamVjdC5rZXlzKGluaS5kYXRhKVxyXG4gICAgICAgIC5tYXAoKGl0ZXIsIGlkeCk6IHR5cGVzLklMb2FkT3JkZXJFbnRyeSA9PiB7XHJcbiAgICAgICAgICBjb25zdCBlbnRyeSA9IGluaS5kYXRhW2l0ZXJdO1xyXG4gICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgaWQ6IGl0ZXIsXHJcbiAgICAgICAgICAgIG5hbWU6IGZpbmROYW1lKGl0ZXIpLFxyXG4gICAgICAgICAgICBlbmFibGVkOiBlbnRyeS5FbmFibGVkID09PSAxLFxyXG4gICAgICAgICAgICBtb2RJZDogZW50cnk/LlZLID8/IGl0ZXIsXHJcbiAgICAgICAgICAgIGxvY2tlZDogaXRlci5zdGFydHNXaXRoKExPQ0tFRF9QUkVGSVgpLFxyXG4gICAgICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICAgICAgcHJlZml4OiBpbmkuZGF0YT8uW2lkeF0/LlByaW9yaXR5ICE9PSB1bmRlZmluZWQgPyAraW5pLmRhdGFbaWR4XS5Qcmlvcml0eSA6IGlkeCArIDEsXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShlbnRyaWVzLnNvcnQoKGEsYikgPT4gYi5kYXRhLnByZWZpeCAtIGEuZGF0YS5wcmVmaXgpKTtcclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICByZXR1cm4gXHJcbiAgICB9XHJcblxyXG4gICAgLy8gY29uc3QgcmVhZGFibGVOYW1lcyA9IHtcclxuICAgIC8vICAgW1VOSV9QQVRDSF06ICdVbmlmaWNhdGlvbi9Db21tdW5pdHkgUGF0Y2gnLFxyXG4gICAgLy8gfTtcclxuICAgIC8vIGNvbnN0IGFsbE1vZHMgPSBhd2FpdCBnZXRBbGxNb2RzKHRoaXMubUFwaSk7XHJcbiAgICAvLyBjb25zdCBsb2NrZWRNb2RzID0gW10uY29uY2F0KGFsbE1vZHMubWFudWFsLmZpbHRlcihpc0xvY2tlZEVudHJ5KSxcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxsTW9kcy5tYW5hZ2VkLmZpbHRlcihlbnRyeSA9PiBpc0xvY2tlZEVudHJ5KGVudHJ5Lm5hbWUpKVxyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLm1hcChlbnRyeSA9PiBlbnRyeS5uYW1lKSk7XHJcbiAgICAvLyBjb25zdCBsb2NrZWRFbnRyaWVzID0gW10uY29uY2F0KGFsbE1vZHMubWVyZ2VkLCBsb2NrZWRNb2RzKVxyXG4gICAgLy8gICAucmVkdWNlKChhY2N1bSwgbW9kTmFtZSwgaWR4KSA9PiB7XHJcbiAgICAvLyAgICAgY29uc3Qgb2JqID0ge1xyXG4gICAgLy8gICAgICAgaWQ6IG1vZE5hbWUsXHJcbiAgICAvLyAgICAgICBuYW1lOiAhIXJlYWRhYmxlTmFtZXNbbW9kTmFtZV0gPyByZWFkYWJsZU5hbWVzW21vZE5hbWVdIDogbW9kTmFtZSxcclxuICAgIC8vICAgICAgIGxvY2tlZDogdHJ1ZSxcclxuICAgIC8vICAgICAgIGRhdGE6IHtcclxuICAgIC8vICAgICAgICAgcHJlZml4OiBpZHggKyAxLFxyXG4gICAgLy8gICAgICAgfVxyXG4gICAgLy8gICAgIH07XHJcbiAgICAvLyAgICAgaWYgKCFhY2N1bS5maW5kKGFjYyA9PiBvYmouaWQgPT09IGFjYy5pZCkpIHtcclxuICAgIC8vICAgICAgIGFjY3VtLnB1c2gob2JqKTtcclxuICAgIC8vICAgICB9XHJcbiAgICAvLyAgICAgcmV0dXJuIGFjY3VtO1xyXG4gICAgLy8gICB9LCBbXSk7XHJcbiAgICBcclxuICAgIC8vIGNvbnN0IG1hbnVhbEVudHJpZXMgPSBhbGxNb2RzLm1hbnVhbC5maWx0ZXIoa2V5ID0+XHJcbiAgICAvLyAgICAgICAgKGxvY2tlZEVudHJpZXMuZmluZChlbnRyeSA9PiBlbnRyeS5pZCA9PT0ga2V5KSA9PT0gdW5kZWZpbmVkKVxyXG4gICAgLy8gICAgICYmIChhbGxNb2RzLm1hbmFnZWQuZmluZChlbnRyeSA9PiBlbnRyeS5pZCA9PT0ga2V5KSA9PT0gdW5kZWZpbmVkKSlcclxuICAgIC8vICAgLm1hcChrZXkgPT4ge1xyXG4gICAgLy8gICAgIGNvbnN0IGl0ZW06IHR5cGVzLklMb2FkT3JkZXJFbnRyeSA9IHtcclxuICAgIC8vICAgICAgIGlkOiBrZXksXHJcbiAgICAvLyAgICAgICBuYW1lOiBrZXksXHJcbiAgICAvLyAgICAgICBtb2RJZDoga2V5LFxyXG4gICAgLy8gICAgICAgZW5hYmxlZDogdHJ1ZSxcclxuICAgIC8vICAgICB9O1xyXG4gICAgLy8gICAgIHJldHVybiB7XHJcbiAgICAvLyAgICAgICAuLi5pdGVtLFxyXG4gICAgLy8gICAgICAgZGF0YToge1xyXG4gICAgLy8gICAgICAgICBwcmVmaXg6IGdldFByaW9yaXR5KGl0ZW0pLFxyXG4gICAgLy8gICAgICAgfVxyXG4gICAgLy8gICAgIH07XHJcbiAgICAvLyB9KTtcclxuICBcclxuICAgIC8vIGNvbnN0IGxvYWRPcmRlciA9IGdldFBlcnNpc3RlbnRMb2FkT3JkZXIodGhpcy5tQXBpKTtcclxuICAgIC8vIGNvbnN0IGtub3duTWFudWFsbHlBZGRlZCA9IG1hbnVhbEVudHJpZXMuZmlsdGVyKGVudHJ5ID0+IGxvYWRPcmRlci5maW5kSW5kZXgoZSA9PiBlLmlkID09PSBlbnRyeS5pZCkgIT09IC0xKSB8fCBbXTtcclxuICAgIC8vIGNvbnN0IHVua25vd25NYW51YWxseUFkZGVkID0gbWFudWFsRW50cmllcy5maWx0ZXIoZW50cnkgPT4gbG9hZE9yZGVyLmZpbmRJbmRleChlID0+IGUuaWQgPT09IGVudHJ5LmlkKSA9PT0gLTEpIHx8IFtdO1xyXG4gICAgLy8gY29uc3QgbG8gPSBbYWxsTW9kcy5tZXJnZWQsIGxvY2tlZCwgYWxsTW9kcy5tYW5hZ2VkLCBtYW51YWxFbnRyaWVzXTtcclxuXHJcbiAgXHJcbiAgICAvLyBsZXQgaXRlbXMgPSBsb2FkT3JkZXIuZmlsdGVyKGl0ZW0gPT4gIWFsbE1vZHMubWVyZ2VkLmluY2x1ZGVzKGl0ZW0uaWQpXHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICYmICFhbGxNb2RzLm1hbnVhbC5pbmNsdWRlcyhpdGVtLmlkKVxyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAmJiAhYWxsTW9kcy5tYW5hZ2VkLmZpbmQobW9kID0+XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChtb2QubmFtZSA9PT0gVU5JX1BBVENIKSAmJiAobW9kLmlkID09PSBpdGVtLmlkKSkpXHJcbiAgICAvLyAgICAgICAgICAgICAgLm1hcCgoaXRlbSwgaWR4KSA9PiB7XHJcbiAgICAvLyAgIGlmIChpZHggPT09IDApIHtcclxuICAgIC8vICAgICByZXNldE1heFByaW9yaXR5KGxvY2tlZEVudHJpZXMubGVuZ3RoKTtcclxuICAgIC8vICAgfVxyXG4gICAgLy8gICByZXR1cm4ge1xyXG4gICAgLy8gICAgIC4uLml0ZW0sXHJcbiAgICAvLyAgICAgZGF0YToge1xyXG4gICAgLy8gICAgICAgcHJlZml4OiBnZXRQcmlvcml0eShpdGVtKSxcclxuICAgIC8vICAgICB9LFxyXG4gICAgLy8gICB9O1xyXG4gICAgLy8gfSk7XHJcblxyXG4gICAgLy8gY29uc3QgZmlsdGVyZWRPcmRlciA9IGxvYWRPcmRlclxyXG4gICAgLy8gICAuZmlsdGVyKGtleSA9PiBsb2NrZWRFbnRyaWVzLmZpbmQoaXRlbSA9PiBpdGVtLmlkID09PSBrZXkpID09PSB1bmRlZmluZWQpXHJcbiAgICAvLyAgIC5yZWR1Y2UoKGFjY3VtLCBrZXksIGlkeCkgPT4ge1xyXG4gICAgLy8gICAgIGFjY3VtLnB1c2gobG9hZE9yZGVyW2lkeF0pO1xyXG4gICAgLy8gICAgIHJldHVybiBhY2N1bTtcclxuICAgIC8vICAgfSwgW10pO1xyXG4gICAgLy8ga25vd25NYW51YWxseUFkZGVkLmZvckVhY2goa25vd24gPT4ge1xyXG4gICAgLy8gICBjb25zdCBkaWZmID0gbG9hZE9yZGVyLmxlbmd0aCAtIGZpbHRlcmVkT3JkZXIubGVuZ3RoO1xyXG4gIFxyXG4gICAgLy8gICBjb25zdCBwb3MgPSBmaWx0ZXJlZE9yZGVyW2tub3duLmlkXS5wb3MgLSBkaWZmO1xyXG4gICAgLy8gICBpdGVtcyA9IFtdLmNvbmNhdChpdGVtcy5zbGljZSgwLCBwb3MpIHx8IFtdLCBrbm93biwgaXRlbXMuc2xpY2UocG9zKSB8fCBbXSk7XHJcbiAgICAvLyB9KTtcclxuICBcclxuICAgIC8vIGxldCBwcmVTb3J0ZWQgPSBbXS5jb25jYXQoXHJcbiAgICAvLyAgIC4uLmxvY2tlZEVudHJpZXMsXHJcbiAgICAvLyAgIGl0ZW1zLmZpbHRlcihpdGVtID0+IHtcclxuICAgIC8vICAgICBpZiAodHlwZW9mKGl0ZW0/Lm5hbWUpICE9PSAnc3RyaW5nJykge1xyXG4gICAgLy8gICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgLy8gICAgIH1cclxuICAgIC8vICAgICBjb25zdCBpc0xvY2tlZCA9IGxvY2tlZEVudHJpZXMuZmluZChsb2NrZWQgPT4gbG9ja2VkLm5hbWUgPT09IGl0ZW0ubmFtZSkgIT09IHVuZGVmaW5lZDtcclxuICAgIC8vICAgICBjb25zdCBkb05vdERpc3BsYXkgPSBET19OT1RfRElTUExBWS5pbmNsdWRlcyhpdGVtLm5hbWUudG9Mb3dlckNhc2UoKSk7XHJcbiAgICAvLyAgICAgcmV0dXJuICFpc0xvY2tlZCAmJiAhZG9Ob3REaXNwbGF5O1xyXG4gICAgLy8gICB9KSxcclxuICAgIC8vICAgLi4udW5rbm93bk1hbnVhbGx5QWRkZWQpO1xyXG4gIFxyXG4gICAgLy8gY29uc3QgaXNFeHRlcm5hbCA9IChlbnRyeSkgPT4gYWxsTW9kcy5tYW5hZ2VkLmZpbmQobWFuID0+IG1hbi5pZCA9PT0gZW50cnkuaWQpID09PSB1bmRlZmluZWQ7XHJcbiAgICAvLyBwcmVTb3J0ZWQgPSBwcmVTb3J0ZWQucmVkdWNlKChhY2N1bSwgZW50cnksIGlkeCkgPT4ge1xyXG4gICAgLy8gICBpZiAobG9ja2VkRW50cmllcy5pbmRleE9mKGVudHJ5KSAhPT0gLTEgfHwgaWR4ID09PSAwKSB7XHJcbiAgICAvLyAgICAgYWNjdW0ucHVzaChlbnRyeSk7XHJcbiAgICAvLyAgIH0gZWxzZSB7XHJcbiAgICAvLyAgICAgY29uc3QgcHJldlByZWZpeCA9IHBhcnNlSW50KGFjY3VtW2lkeCAtIDFdPy5kYXRhPy5wcmVmaXgsIDEwKTtcclxuICAgIC8vICAgICBpZiAocHJldlByZWZpeCA+PSBlbnRyeT8ucHJlZml4KSB7XHJcbiAgICAvLyAgICAgICBhY2N1bS5wdXNoKHtcclxuICAgIC8vICAgICAgICAgLi4uZW50cnksXHJcbiAgICAvLyAgICAgICAgIGRhdGE6IHtcclxuICAgIC8vICAgICAgICAgICBwcmVmaXg6IHByZXZQcmVmaXggKyAxLFxyXG4gICAgLy8gICAgICAgICB9XHJcbiAgICAvLyAgICAgICB9KTtcclxuICAgIC8vICAgICB9IGVsc2Uge1xyXG4gICAgLy8gICAgICAgYWNjdW0ucHVzaCh7IC4uLmVudHJ5IH0pO1xyXG4gICAgLy8gICAgIH1cclxuICAgIC8vICAgfVxyXG4gICAgLy8gICByZXR1cm4gYWNjdW07XHJcbiAgICAvLyB9LCBbXSk7XHJcbiAgICAvLyByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHByZVNvcnRlZCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgdmFsaWRhdGUocHJldjogdHlwZXMuTG9hZE9yZGVyLCBjdXJyZW50OiB0eXBlcy5Mb2FkT3JkZXIpOiBQcm9taXNlPHR5cGVzLklWYWxpZGF0aW9uUmVzdWx0PiB7XHJcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHVuZGVmaW5lZCk7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBUVzNMb2FkT3JkZXI7Il19