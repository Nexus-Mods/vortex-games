"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const react_1 = __importDefault(require("react"));
const vortex_api_1 = require("vortex-api");
const common_1 = require("./common");
const InfoComponent_1 = __importDefault(require("./views/InfoComponent"));
const iniParser_1 = __importDefault(require("./iniParser"));
;
class TW3LoadOrder {
    constructor(props) {
        this.gameId = common_1.GAME_ID;
        this.clearStateOnPurge = true;
        this.toggleableEntries = true;
        this.noCollectionGeneration = true;
        this.usageInstructions = () => (react_1.default.createElement(InfoComponent_1.default, { onToggleModsState: props.onToggleModsState }));
        this.mApi = props.api;
        this.mPriorityManager = props.priorityManager;
        this.deserializeLoadOrder = this.deserializeLoadOrder.bind(this);
        this.serializeLoadOrder = this.serializeLoadOrder.bind(this);
        this.validate = this.validate.bind(this);
    }
    serializeLoadOrder(loadOrder) {
        return __awaiter(this, void 0, void 0, function* () {
            yield iniParser_1.default.getInstance(this.mApi, this.mPriorityManager).setINIStruct(loadOrder, this.mPriorityManager);
            return iniParser_1.default.getInstance(this.mApi, this.mPriorityManager).writeToModSettings();
        });
    }
    deserializeLoadOrder() {
        return __awaiter(this, void 0, void 0, function* () {
            const state = this.mApi.getState();
            const activeProfile = vortex_api_1.selectors.activeProfile(state);
            if ((activeProfile === null || activeProfile === void 0 ? void 0 : activeProfile.id) === undefined) {
                return Promise.resolve([]);
            }
            try {
                const ini = yield iniParser_1.default.getInstance(this.mApi, this.mPriorityManager).readStructure();
                const entries = Object.keys(ini.data)
                    .map((iter, idx) => {
                    var _a;
                    const entry = ini.data[iter];
                    return {
                        id: iter,
                        name: entry.Name,
                        enabled: entry.Enabled === 1,
                        modId: (_a = entry === null || entry === void 0 ? void 0 : entry.VK) !== null && _a !== void 0 ? _a : iter,
                        locked: iter.startsWith(common_1.LOCKED_PREFIX),
                        data: {
                            prefix: ini.data[idx].Priority,
                        }
                    };
                });
                return Promise.resolve(entries.sort((a, b) => a.data.prefix - b.data.prefix));
            }
            catch (err) {
                return;
            }
        });
    }
    validate(prev, current) {
        return __awaiter(this, void 0, void 0, function* () {
            return Promise.resolve(undefined);
        });
    }
}
exports.default = TW3LoadOrder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZE9yZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibG9hZE9yZGVyLnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUNBLGtEQUEwQjtBQUMxQiwyQ0FBOEM7QUFFOUMscUNBQXdFO0FBQ3hFLDBFQUFrRDtBQUNsRCw0REFBdUM7QUFPdEMsQ0FBQztBQUVGLE1BQU0sWUFBWTtJQVVoQixZQUFZLEtBQWlCO1FBQzNCLElBQUksQ0FBQyxNQUFNLEdBQUcsZ0JBQU8sQ0FBQztRQUN0QixJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDO1FBQzlCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUM7UUFDOUIsSUFBSSxDQUFDLHNCQUFzQixHQUFHLElBQUksQ0FBQztRQUNuQyxJQUFJLENBQUMsaUJBQWlCLEdBQUcsR0FBRyxFQUFFLENBQUMsQ0FBQyw4QkFBQyx1QkFBYSxJQUFDLGlCQUFpQixFQUFFLEtBQUssQ0FBQyxpQkFBaUIsR0FBRyxDQUFDLENBQUM7UUFDOUYsSUFBSSxDQUFDLElBQUksR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDO1FBQ3RCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxLQUFLLENBQUMsZUFBZSxDQUFDO1FBQzlDLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2pFLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzdELElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDM0MsQ0FBQztJQUVZLGtCQUFrQixDQUFDLFNBQTBCOztZQUN4RCxNQUFNLG1CQUFZLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUMsWUFBWSxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztZQUNoSCxPQUFPLG1CQUFZLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztRQUN6RixDQUFDO0tBQUE7SUFFWSxvQkFBb0I7O1lBQy9CLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDbkMsTUFBTSxhQUFhLEdBQUcsc0JBQVMsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDckQsSUFBSSxDQUFBLGFBQWEsYUFBYixhQUFhLHVCQUFiLGFBQWEsQ0FBRSxFQUFFLE1BQUssU0FBUyxFQUFFO2dCQUNuQyxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7YUFDNUI7WUFDRCxJQUFJO2dCQUNGLE1BQU0sR0FBRyxHQUFHLE1BQU0sbUJBQVksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxhQUFhLEVBQUUsQ0FBQztnQkFDN0YsTUFBTSxPQUFPLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO3FCQUNsQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUF5QixFQUFFOztvQkFDeEMsTUFBTSxLQUFLLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDN0IsT0FBTzt3QkFDTCxFQUFFLEVBQUUsSUFBSTt3QkFDUixJQUFJLEVBQUUsS0FBSyxDQUFDLElBQUk7d0JBQ2hCLE9BQU8sRUFBRSxLQUFLLENBQUMsT0FBTyxLQUFLLENBQUM7d0JBQzVCLEtBQUssRUFBRSxNQUFBLEtBQUssYUFBTCxLQUFLLHVCQUFMLEtBQUssQ0FBRSxFQUFFLG1DQUFJLElBQUk7d0JBQ3hCLE1BQU0sRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLHNCQUFhLENBQUM7d0JBQ3RDLElBQUksRUFBRTs0QkFDSixNQUFNLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxRQUFRO3lCQUMvQjtxQkFDRixDQUFBO2dCQUNILENBQUMsQ0FBQyxDQUFDO2dCQUNMLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO2FBQzlFO1lBQUMsT0FBTyxHQUFHLEVBQUU7Z0JBQ1osT0FBTTthQUNQO1FBOEdILENBQUM7S0FBQTtJQUVZLFFBQVEsQ0FBQyxJQUFxQixFQUFFLE9BQXdCOztZQUNuRSxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDcEMsQ0FBQztLQUFBO0NBQ0Y7QUFFRCxrQkFBZSxZQUFZLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSAqL1xyXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xyXG5pbXBvcnQgeyBzZWxlY3RvcnMsIHR5cGVzIH0gZnJvbSAndm9ydGV4LWFwaSc7XHJcblxyXG5pbXBvcnQgeyBHQU1FX0lELCBMT0NLRURfUFJFRklYLCBnZXRMb2FkT3JkZXJGaWxlUGF0aCB9IGZyb20gJy4vY29tbW9uJztcclxuaW1wb3J0IEluZm9Db21wb25lbnQgZnJvbSAnLi92aWV3cy9JbmZvQ29tcG9uZW50JztcclxuaW1wb3J0IEluaVN0cnVjdHVyZSBmcm9tICcuL2luaVBhcnNlcic7XHJcbmltcG9ydCB7IFByaW9yaXR5TWFuYWdlciB9IGZyb20gJy4vcHJpb3JpdHlNYW5hZ2VyJztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgSUJhc2VQcm9wcyB7XHJcbiAgYXBpOiB0eXBlcy5JRXh0ZW5zaW9uQXBpO1xyXG4gIHByaW9yaXR5TWFuYWdlcjogUHJpb3JpdHlNYW5hZ2VyO1xyXG4gIG9uVG9nZ2xlTW9kc1N0YXRlOiAoZW5hYmxlOiBib29sZWFuKSA9PiB2b2lkO1xyXG59O1xyXG5cclxuY2xhc3MgVFczTG9hZE9yZGVyIGltcGxlbWVudHMgdHlwZXMuSUxvYWRPcmRlckdhbWVJbmZvIHtcclxuICBwdWJsaWMgZ2FtZUlkOiBzdHJpbmc7XHJcbiAgcHVibGljIHRvZ2dsZWFibGVFbnRyaWVzPzogYm9vbGVhbiB8IHVuZGVmaW5lZDtcclxuICBwdWJsaWMgY2xlYXJTdGF0ZU9uUHVyZ2U/OiBib29sZWFuIHwgdW5kZWZpbmVkO1xyXG4gIHB1YmxpYyB1c2FnZUluc3RydWN0aW9ucz86IFJlYWN0LkNvbXBvbmVudFR5cGU8e30+O1xyXG4gIHB1YmxpYyBub0NvbGxlY3Rpb25HZW5lcmF0aW9uPzogYm9vbGVhbiB8IHVuZGVmaW5lZDtcclxuXHJcbiAgcHJpdmF0ZSBtQXBpOiB0eXBlcy5JRXh0ZW5zaW9uQXBpO1xyXG4gIHByaXZhdGUgbVByaW9yaXR5TWFuYWdlcjogUHJpb3JpdHlNYW5hZ2VyO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcm9wczogSUJhc2VQcm9wcykge1xyXG4gICAgdGhpcy5nYW1lSWQgPSBHQU1FX0lEO1xyXG4gICAgdGhpcy5jbGVhclN0YXRlT25QdXJnZSA9IHRydWU7XHJcbiAgICB0aGlzLnRvZ2dsZWFibGVFbnRyaWVzID0gdHJ1ZTtcclxuICAgIHRoaXMubm9Db2xsZWN0aW9uR2VuZXJhdGlvbiA9IHRydWU7XHJcbiAgICB0aGlzLnVzYWdlSW5zdHJ1Y3Rpb25zID0gKCkgPT4gKDxJbmZvQ29tcG9uZW50IG9uVG9nZ2xlTW9kc1N0YXRlPXtwcm9wcy5vblRvZ2dsZU1vZHNTdGF0ZX0vPik7XHJcbiAgICB0aGlzLm1BcGkgPSBwcm9wcy5hcGk7XHJcbiAgICB0aGlzLm1Qcmlvcml0eU1hbmFnZXIgPSBwcm9wcy5wcmlvcml0eU1hbmFnZXI7XHJcbiAgICB0aGlzLmRlc2VyaWFsaXplTG9hZE9yZGVyID0gdGhpcy5kZXNlcmlhbGl6ZUxvYWRPcmRlci5iaW5kKHRoaXMpO1xyXG4gICAgdGhpcy5zZXJpYWxpemVMb2FkT3JkZXIgPSB0aGlzLnNlcmlhbGl6ZUxvYWRPcmRlci5iaW5kKHRoaXMpO1xyXG4gICAgdGhpcy52YWxpZGF0ZSA9IHRoaXMudmFsaWRhdGUuYmluZCh0aGlzKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBzZXJpYWxpemVMb2FkT3JkZXIobG9hZE9yZGVyOiB0eXBlcy5Mb2FkT3JkZXIpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGF3YWl0IEluaVN0cnVjdHVyZS5nZXRJbnN0YW5jZSh0aGlzLm1BcGksIHRoaXMubVByaW9yaXR5TWFuYWdlcikuc2V0SU5JU3RydWN0KGxvYWRPcmRlciwgdGhpcy5tUHJpb3JpdHlNYW5hZ2VyKTtcclxuICAgIHJldHVybiBJbmlTdHJ1Y3R1cmUuZ2V0SW5zdGFuY2UodGhpcy5tQXBpLCB0aGlzLm1Qcmlvcml0eU1hbmFnZXIpLndyaXRlVG9Nb2RTZXR0aW5ncygpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIGRlc2VyaWFsaXplTG9hZE9yZGVyKCk6IFByb21pc2U8dHlwZXMuTG9hZE9yZGVyPiB7XHJcbiAgICBjb25zdCBzdGF0ZSA9IHRoaXMubUFwaS5nZXRTdGF0ZSgpO1xyXG4gICAgY29uc3QgYWN0aXZlUHJvZmlsZSA9IHNlbGVjdG9ycy5hY3RpdmVQcm9maWxlKHN0YXRlKTtcclxuICAgIGlmIChhY3RpdmVQcm9maWxlPy5pZCA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoW10pO1xyXG4gICAgfVxyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgaW5pID0gYXdhaXQgSW5pU3RydWN0dXJlLmdldEluc3RhbmNlKHRoaXMubUFwaSwgdGhpcy5tUHJpb3JpdHlNYW5hZ2VyKS5yZWFkU3RydWN0dXJlKCk7XHJcbiAgICAgIGNvbnN0IGVudHJpZXMgPSBPYmplY3Qua2V5cyhpbmkuZGF0YSlcclxuICAgICAgICAubWFwKChpdGVyLCBpZHgpOiB0eXBlcy5JTG9hZE9yZGVyRW50cnkgPT4ge1xyXG4gICAgICAgICAgY29uc3QgZW50cnkgPSBpbmkuZGF0YVtpdGVyXTtcclxuICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGlkOiBpdGVyLFxyXG4gICAgICAgICAgICBuYW1lOiBlbnRyeS5OYW1lLFxyXG4gICAgICAgICAgICBlbmFibGVkOiBlbnRyeS5FbmFibGVkID09PSAxLFxyXG4gICAgICAgICAgICBtb2RJZDogZW50cnk/LlZLID8/IGl0ZXIsXHJcbiAgICAgICAgICAgIGxvY2tlZDogaXRlci5zdGFydHNXaXRoKExPQ0tFRF9QUkVGSVgpLFxyXG4gICAgICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICAgICAgcHJlZml4OiBpbmkuZGF0YVtpZHhdLlByaW9yaXR5LFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZW50cmllcy5zb3J0KChhLGIpID0+IGEuZGF0YS5wcmVmaXggLSBiLmRhdGEucHJlZml4KSk7XHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgcmV0dXJuIFxyXG4gICAgfVxyXG5cclxuICAgIC8vIGNvbnN0IHJlYWRhYmxlTmFtZXMgPSB7XHJcbiAgICAvLyAgIFtVTklfUEFUQ0hdOiAnVW5pZmljYXRpb24vQ29tbXVuaXR5IFBhdGNoJyxcclxuICAgIC8vIH07XHJcbiAgICAvLyBjb25zdCBhbGxNb2RzID0gYXdhaXQgZ2V0QWxsTW9kcyh0aGlzLm1BcGkpO1xyXG4gICAgLy8gY29uc3QgbG9ja2VkTW9kcyA9IFtdLmNvbmNhdChhbGxNb2RzLm1hbnVhbC5maWx0ZXIoaXNMb2NrZWRFbnRyeSksXHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsbE1vZHMubWFuYWdlZC5maWx0ZXIoZW50cnkgPT4gaXNMb2NrZWRFbnRyeShlbnRyeS5uYW1lKSlcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoZW50cnkgPT4gZW50cnkubmFtZSkpO1xyXG4gICAgLy8gY29uc3QgbG9ja2VkRW50cmllcyA9IFtdLmNvbmNhdChhbGxNb2RzLm1lcmdlZCwgbG9ja2VkTW9kcylcclxuICAgIC8vICAgLnJlZHVjZSgoYWNjdW0sIG1vZE5hbWUsIGlkeCkgPT4ge1xyXG4gICAgLy8gICAgIGNvbnN0IG9iaiA9IHtcclxuICAgIC8vICAgICAgIGlkOiBtb2ROYW1lLFxyXG4gICAgLy8gICAgICAgbmFtZTogISFyZWFkYWJsZU5hbWVzW21vZE5hbWVdID8gcmVhZGFibGVOYW1lc1ttb2ROYW1lXSA6IG1vZE5hbWUsXHJcbiAgICAvLyAgICAgICBsb2NrZWQ6IHRydWUsXHJcbiAgICAvLyAgICAgICBkYXRhOiB7XHJcbiAgICAvLyAgICAgICAgIHByZWZpeDogaWR4ICsgMSxcclxuICAgIC8vICAgICAgIH1cclxuICAgIC8vICAgICB9O1xyXG4gICAgLy8gICAgIGlmICghYWNjdW0uZmluZChhY2MgPT4gb2JqLmlkID09PSBhY2MuaWQpKSB7XHJcbiAgICAvLyAgICAgICBhY2N1bS5wdXNoKG9iaik7XHJcbiAgICAvLyAgICAgfVxyXG4gICAgLy8gICAgIHJldHVybiBhY2N1bTtcclxuICAgIC8vICAgfSwgW10pO1xyXG4gICAgXHJcbiAgICAvLyBjb25zdCBtYW51YWxFbnRyaWVzID0gYWxsTW9kcy5tYW51YWwuZmlsdGVyKGtleSA9PlxyXG4gICAgLy8gICAgICAgIChsb2NrZWRFbnRyaWVzLmZpbmQoZW50cnkgPT4gZW50cnkuaWQgPT09IGtleSkgPT09IHVuZGVmaW5lZClcclxuICAgIC8vICAgICAmJiAoYWxsTW9kcy5tYW5hZ2VkLmZpbmQoZW50cnkgPT4gZW50cnkuaWQgPT09IGtleSkgPT09IHVuZGVmaW5lZCkpXHJcbiAgICAvLyAgIC5tYXAoa2V5ID0+IHtcclxuICAgIC8vICAgICBjb25zdCBpdGVtOiB0eXBlcy5JTG9hZE9yZGVyRW50cnkgPSB7XHJcbiAgICAvLyAgICAgICBpZDoga2V5LFxyXG4gICAgLy8gICAgICAgbmFtZToga2V5LFxyXG4gICAgLy8gICAgICAgbW9kSWQ6IGtleSxcclxuICAgIC8vICAgICAgIGVuYWJsZWQ6IHRydWUsXHJcbiAgICAvLyAgICAgfTtcclxuICAgIC8vICAgICByZXR1cm4ge1xyXG4gICAgLy8gICAgICAgLi4uaXRlbSxcclxuICAgIC8vICAgICAgIGRhdGE6IHtcclxuICAgIC8vICAgICAgICAgcHJlZml4OiBnZXRQcmlvcml0eShpdGVtKSxcclxuICAgIC8vICAgICAgIH1cclxuICAgIC8vICAgICB9O1xyXG4gICAgLy8gfSk7XHJcbiAgXHJcbiAgICAvLyBjb25zdCBsb2FkT3JkZXIgPSBnZXRQZXJzaXN0ZW50TG9hZE9yZGVyKHRoaXMubUFwaSk7XHJcbiAgICAvLyBjb25zdCBrbm93bk1hbnVhbGx5QWRkZWQgPSBtYW51YWxFbnRyaWVzLmZpbHRlcihlbnRyeSA9PiBsb2FkT3JkZXIuZmluZEluZGV4KGUgPT4gZS5pZCA9PT0gZW50cnkuaWQpICE9PSAtMSkgfHwgW107XHJcbiAgICAvLyBjb25zdCB1bmtub3duTWFudWFsbHlBZGRlZCA9IG1hbnVhbEVudHJpZXMuZmlsdGVyKGVudHJ5ID0+IGxvYWRPcmRlci5maW5kSW5kZXgoZSA9PiBlLmlkID09PSBlbnRyeS5pZCkgPT09IC0xKSB8fCBbXTtcclxuICAgIC8vIGNvbnN0IGxvID0gW2FsbE1vZHMubWVyZ2VkLCBsb2NrZWQsIGFsbE1vZHMubWFuYWdlZCwgbWFudWFsRW50cmllc107XHJcblxyXG4gIFxyXG4gICAgLy8gbGV0IGl0ZW1zID0gbG9hZE9yZGVyLmZpbHRlcihpdGVtID0+ICFhbGxNb2RzLm1lcmdlZC5pbmNsdWRlcyhpdGVtLmlkKVxyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAmJiAhYWxsTW9kcy5tYW51YWwuaW5jbHVkZXMoaXRlbS5pZClcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgIWFsbE1vZHMubWFuYWdlZC5maW5kKG1vZCA9PlxyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAobW9kLm5hbWUgPT09IFVOSV9QQVRDSCkgJiYgKG1vZC5pZCA9PT0gaXRlbS5pZCkpKVxyXG4gICAgLy8gICAgICAgICAgICAgIC5tYXAoKGl0ZW0sIGlkeCkgPT4ge1xyXG4gICAgLy8gICBpZiAoaWR4ID09PSAwKSB7XHJcbiAgICAvLyAgICAgcmVzZXRNYXhQcmlvcml0eShsb2NrZWRFbnRyaWVzLmxlbmd0aCk7XHJcbiAgICAvLyAgIH1cclxuICAgIC8vICAgcmV0dXJuIHtcclxuICAgIC8vICAgICAuLi5pdGVtLFxyXG4gICAgLy8gICAgIGRhdGE6IHtcclxuICAgIC8vICAgICAgIHByZWZpeDogZ2V0UHJpb3JpdHkoaXRlbSksXHJcbiAgICAvLyAgICAgfSxcclxuICAgIC8vICAgfTtcclxuICAgIC8vIH0pO1xyXG5cclxuICAgIC8vIGNvbnN0IGZpbHRlcmVkT3JkZXIgPSBsb2FkT3JkZXJcclxuICAgIC8vICAgLmZpbHRlcihrZXkgPT4gbG9ja2VkRW50cmllcy5maW5kKGl0ZW0gPT4gaXRlbS5pZCA9PT0ga2V5KSA9PT0gdW5kZWZpbmVkKVxyXG4gICAgLy8gICAucmVkdWNlKChhY2N1bSwga2V5LCBpZHgpID0+IHtcclxuICAgIC8vICAgICBhY2N1bS5wdXNoKGxvYWRPcmRlcltpZHhdKTtcclxuICAgIC8vICAgICByZXR1cm4gYWNjdW07XHJcbiAgICAvLyAgIH0sIFtdKTtcclxuICAgIC8vIGtub3duTWFudWFsbHlBZGRlZC5mb3JFYWNoKGtub3duID0+IHtcclxuICAgIC8vICAgY29uc3QgZGlmZiA9IGxvYWRPcmRlci5sZW5ndGggLSBmaWx0ZXJlZE9yZGVyLmxlbmd0aDtcclxuICBcclxuICAgIC8vICAgY29uc3QgcG9zID0gZmlsdGVyZWRPcmRlcltrbm93bi5pZF0ucG9zIC0gZGlmZjtcclxuICAgIC8vICAgaXRlbXMgPSBbXS5jb25jYXQoaXRlbXMuc2xpY2UoMCwgcG9zKSB8fCBbXSwga25vd24sIGl0ZW1zLnNsaWNlKHBvcykgfHwgW10pO1xyXG4gICAgLy8gfSk7XHJcbiAgXHJcbiAgICAvLyBsZXQgcHJlU29ydGVkID0gW10uY29uY2F0KFxyXG4gICAgLy8gICAuLi5sb2NrZWRFbnRyaWVzLFxyXG4gICAgLy8gICBpdGVtcy5maWx0ZXIoaXRlbSA9PiB7XHJcbiAgICAvLyAgICAgaWYgKHR5cGVvZihpdGVtPy5uYW1lKSAhPT0gJ3N0cmluZycpIHtcclxuICAgIC8vICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIC8vICAgICB9XHJcbiAgICAvLyAgICAgY29uc3QgaXNMb2NrZWQgPSBsb2NrZWRFbnRyaWVzLmZpbmQobG9ja2VkID0+IGxvY2tlZC5uYW1lID09PSBpdGVtLm5hbWUpICE9PSB1bmRlZmluZWQ7XHJcbiAgICAvLyAgICAgY29uc3QgZG9Ob3REaXNwbGF5ID0gRE9fTk9UX0RJU1BMQVkuaW5jbHVkZXMoaXRlbS5uYW1lLnRvTG93ZXJDYXNlKCkpO1xyXG4gICAgLy8gICAgIHJldHVybiAhaXNMb2NrZWQgJiYgIWRvTm90RGlzcGxheTtcclxuICAgIC8vICAgfSksXHJcbiAgICAvLyAgIC4uLnVua25vd25NYW51YWxseUFkZGVkKTtcclxuICBcclxuICAgIC8vIGNvbnN0IGlzRXh0ZXJuYWwgPSAoZW50cnkpID0+IGFsbE1vZHMubWFuYWdlZC5maW5kKG1hbiA9PiBtYW4uaWQgPT09IGVudHJ5LmlkKSA9PT0gdW5kZWZpbmVkO1xyXG4gICAgLy8gcHJlU29ydGVkID0gcHJlU29ydGVkLnJlZHVjZSgoYWNjdW0sIGVudHJ5LCBpZHgpID0+IHtcclxuICAgIC8vICAgaWYgKGxvY2tlZEVudHJpZXMuaW5kZXhPZihlbnRyeSkgIT09IC0xIHx8IGlkeCA9PT0gMCkge1xyXG4gICAgLy8gICAgIGFjY3VtLnB1c2goZW50cnkpO1xyXG4gICAgLy8gICB9IGVsc2Uge1xyXG4gICAgLy8gICAgIGNvbnN0IHByZXZQcmVmaXggPSBwYXJzZUludChhY2N1bVtpZHggLSAxXT8uZGF0YT8ucHJlZml4LCAxMCk7XHJcbiAgICAvLyAgICAgaWYgKHByZXZQcmVmaXggPj0gZW50cnk/LnByZWZpeCkge1xyXG4gICAgLy8gICAgICAgYWNjdW0ucHVzaCh7XHJcbiAgICAvLyAgICAgICAgIC4uLmVudHJ5LFxyXG4gICAgLy8gICAgICAgICBkYXRhOiB7XHJcbiAgICAvLyAgICAgICAgICAgcHJlZml4OiBwcmV2UHJlZml4ICsgMSxcclxuICAgIC8vICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgfSk7XHJcbiAgICAvLyAgICAgfSBlbHNlIHtcclxuICAgIC8vICAgICAgIGFjY3VtLnB1c2goeyAuLi5lbnRyeSB9KTtcclxuICAgIC8vICAgICB9XHJcbiAgICAvLyAgIH1cclxuICAgIC8vICAgcmV0dXJuIGFjY3VtO1xyXG4gICAgLy8gfSwgW10pO1xyXG4gICAgLy8gcmV0dXJuIFByb21pc2UucmVzb2x2ZShwcmVTb3J0ZWQpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIHZhbGlkYXRlKHByZXY6IHR5cGVzLkxvYWRPcmRlciwgY3VycmVudDogdHlwZXMuTG9hZE9yZGVyKTogUHJvbWlzZTx0eXBlcy5JVmFsaWRhdGlvblJlc3VsdD4ge1xyXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh1bmRlZmluZWQpO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgVFczTG9hZE9yZGVyOyJdfQ==