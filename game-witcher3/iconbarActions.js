"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.registerActions = void 0;
const path_1 = __importDefault(require("path"));
const vortex_api_1 = require("vortex-api");
const common_1 = require("./common");
const mergeBackup_1 = require("./mergeBackup");
const util_1 = require("./util");
const migrations_1 = require("./migrations");
const registerActions = (props) => {
    const { context, getModLimitPatcher } = props;
    const openTW3DocPath = () => {
        const docPath = path_1.default.join(vortex_api_1.util.getVortexPath('documents'), 'The Witcher 3');
        vortex_api_1.util.opn(docPath).catch(() => null);
    };
    const isTW3 = (gameId = undefined) => {
        if (gameId !== undefined) {
            return (gameId === common_1.GAME_ID);
        }
        const state = context.api.getState();
        const gameMode = vortex_api_1.selectors.activeGameId(state);
        return (gameMode === common_1.GAME_ID);
    };
    context.registerAction('mods-action-icons', 300, 'start-install', {}, 'Import Script Merges', instanceIds => { (0, mergeBackup_1.makeOnContextImport)(context.api, instanceIds[0]); }, instanceIds => {
        var _a;
        const state = context.api.getState();
        const mods = vortex_api_1.util.getSafe(state, ['persistent', 'mods', common_1.GAME_ID], {});
        if (((_a = mods[instanceIds === null || instanceIds === void 0 ? void 0 : instanceIds[0]]) === null || _a === void 0 ? void 0 : _a.type) !== 'collection') {
            return false;
        }
        const activeGameId = vortex_api_1.selectors.activeGameId(state);
        return activeGameId === common_1.GAME_ID;
    });
    context.registerAction('mod-icons', 500, 'savegame', {}, 'Apply Mod Limit Patch', () => {
        getModLimitPatcher().ensureModLimitPatch()
            .catch(err => {
            context.api.showErrorNotification('Failed to apply patch', err, {
                allowReport: (err instanceof vortex_api_1.util.ProcessCanceled),
            });
        });
    }, () => vortex_api_1.selectors.activeGameId(context.api.getState()) === common_1.GAME_ID);
    context.registerAction('mod-icons', 300, 'open-ext', {}, 'Open TW3 Documents Folder', openTW3DocPath, isTW3);
    context.registerAction('fb-load-order-icons', 300, 'open-ext', {}, 'Open TW3 Documents Folder', openTW3DocPath, isTW3);
    context.registerAction('fb-load-order-icons', 100, 'loot-sort', {}, 'Sort by Deploy Order', () => {
        context.api.showDialog('info', 'Sort by Deployment Order', {
            bbcode: context.api.translate('This action will set priorities using the deployment rules '
                + 'defined in the mods page. Are you sure you wish to proceed ?[br][/br][br][/br]'
                + 'Please be aware that any externally added mods (added manually or by other tools) will be pushed '
                + 'to the bottom of the list, while all mods that have been installed through Vortex will shift '
                + 'in position to match the deploy order!', { ns: common_1.I18N_NAMESPACE }),
        }, [
            { label: 'Cancel', action: () => {
                    return;
                } },
            { label: 'Sort by Deploy Order', action: () => {
                    var _a;
                    const state = context.api.getState();
                    const gameMods = ((_a = state.persistent.mods) === null || _a === void 0 ? void 0 : _a[common_1.GAME_ID]) || {};
                    const profile = vortex_api_1.selectors.activeProfile(state);
                    const mods = Object.keys(gameMods)
                        .filter(key => vortex_api_1.util.getSafe(profile, ['modState', key, 'enabled'], false))
                        .map(key => gameMods[key]);
                    const findIndex = (entry, modList) => {
                        return modList.findIndex(m => m.id === entry.modId);
                    };
                    return vortex_api_1.util.sortMods(common_1.GAME_ID, mods, context.api)
                        .then(sorted => {
                        const loadOrder = (0, migrations_1.getPersistentLoadOrder)(context.api);
                        const filtered = loadOrder.filter(entry => sorted.find(mod => mod.id === entry.id) !== undefined);
                        const sortedLO = filtered.sort((a, b) => findIndex(a, sorted) - findIndex(b, sorted));
                        const locked = loadOrder.filter(entry => entry.name.includes(common_1.LOCKED_PREFIX));
                        const manuallyAdded = loadOrder.filter(key => !filtered.includes(key) && !locked.includes(key));
                        const newLO = [...locked, ...sortedLO, ...manuallyAdded].reduce((accum, entry, idx) => {
                            accum.push(Object.assign(Object.assign({}, entry), { data: {
                                    prefix: idx + 1
                                } }));
                            return accum;
                        }, []);
                        context.api.store.dispatch(vortex_api_1.actions.setLoadOrder(profile.id, newLO));
                    })
                        .catch(err => {
                        const allowReport = !(err instanceof vortex_api_1.util.CycleError);
                        context.api.showErrorNotification('Failed to sort by deployment order', err, { allowReport });
                    }).finally(() => {
                        (0, util_1.forceRefresh)(context.api);
                    });
                } },
        ]);
    }, () => {
        const state = context.api.store.getState();
        const gameMode = vortex_api_1.selectors.activeGameId(state);
        return gameMode === common_1.GAME_ID;
    });
};
exports.registerActions = registerActions;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWNvbmJhckFjdGlvbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpY29uYmFyQWN0aW9ucy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFDQSxnREFBd0I7QUFDeEIsMkNBQTZEO0FBRTdELHFDQUFrRTtBQUdsRSwrQ0FBb0Q7QUFHcEQsaUNBQXNDO0FBQ3RDLDZDQUFzRDtBQVEvQyxNQUFNLGVBQWUsR0FBRyxDQUFDLEtBQWEsRUFBRSxFQUFFO0lBQy9DLE1BQU0sRUFBRSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsR0FBRyxLQUFLLENBQUM7SUFDOUMsTUFBTSxjQUFjLEdBQUcsR0FBRyxFQUFFO1FBQzFCLE1BQU0sT0FBTyxHQUFHLGNBQUksQ0FBQyxJQUFJLENBQUMsaUJBQUksQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLEVBQUUsZUFBZSxDQUFDLENBQUM7UUFDNUUsaUJBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3RDLENBQUMsQ0FBQztJQUVGLE1BQU0sS0FBSyxHQUFHLENBQUMsTUFBTSxHQUFHLFNBQVMsRUFBRSxFQUFFO1FBQ25DLElBQUksTUFBTSxLQUFLLFNBQVMsRUFBRTtZQUN4QixPQUFPLENBQUMsTUFBTSxLQUFLLGdCQUFPLENBQUMsQ0FBQztTQUM3QjtRQUNELE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDckMsTUFBTSxRQUFRLEdBQUcsc0JBQVMsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDL0MsT0FBTyxDQUFDLFFBQVEsS0FBSyxnQkFBTyxDQUFDLENBQUM7SUFDaEMsQ0FBQyxDQUFDO0lBRUYsT0FBTyxDQUFDLGNBQWMsQ0FBQyxtQkFBbUIsRUFBRSxHQUFHLEVBQUUsZUFBZSxFQUFFLEVBQUUsRUFBRSxzQkFBc0IsRUFDMUYsV0FBVyxDQUFDLEVB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QUMsQ0FBQyxDQUFDO2dCQUNQLENBQUMsRUFBQztTQUNILENBQUMsQ0FBQztJQUNMLENBQUMsRUFBRSxHQUFHLEVBQUU7UUFDTixNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUMzQyxNQUFNLFFBQVEsR0FBRyxzQkFBUyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMvQyxPQUFPLFFBQVEsS0FBSyxnQkFBTyxDQUFDO0lBQzlCLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDO0FBbkdXLFFBQUEsZUFBZSxtQkFtRzFCIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgKi9cclxuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XHJcbmltcG9ydCB7IGFjdGlvbnMsIHNlbGVjdG9ycywgdHlwZXMsIHV0aWwgfSBmcm9tICd2b3J0ZXgtYXBpJztcclxuXHJcbmltcG9ydCB7IEdBTUVfSUQsIEkxOE5fTkFNRVNQQUNFLCBMT0NLRURfUFJFRklYIH0gZnJvbSAnLi9jb21tb24nO1xyXG5pbXBvcnQgeyBQcmlvcml0eU1hbmFnZXIgfSBmcm9tICcuL3ByaW9yaXR5TWFuYWdlcic7XHJcblxyXG5pbXBvcnQgeyBtYWtlT25Db250ZXh0SW1wb3J0IH0gZnJvbSAnLi9tZXJnZUJhY2t1cCc7XHJcbmltcG9ydCB7IE1vZExpbWl0UGF0Y2hlciB9IGZyb20gJy4vbW9kTGltaXRQYXRjaCc7XHJcblxyXG5pbXBvcnQgeyBmb3JjZVJlZnJlc2ggfSBmcm9tICcuL3V0aWwnO1xyXG5pbXBvcnQgeyBnZXRQZXJzaXN0ZW50TG9hZE9yZGVyIH0gZnJvbSAnLi9taWdyYXRpb25zJztcclxuXHJcbmludGVyZmFjZSBJUHJvcHMge1xyXG4gIGNvbnRleHQ6IHR5cGVzLklFeHRlbnNpb25Db250ZXh0O1xyXG4gIGdldFByaW9yaXR5TWFuYWdlcjogKCkgPT4gUHJpb3JpdHlNYW5hZ2VyO1xyXG4gIGdldE1vZExpbWl0UGF0Y2hlcjogKCkgPT4gTW9kTGltaXRQYXRjaGVyO1xyXG59XHJcblxyXG5leHBvcnQgY29uc3QgcmVnaXN0ZXJBY3Rpb25zID0gKHByb3BzOiBJUHJvcHMpID0+IHtcclxuICBjb25zdCB7IGNvbnRleHQsIGdldE1vZExpbWl0UGF0Y2hlciB9ID0gcHJvcHM7XHJcbiAgY29uc3Qgb3BlblRXM0RvY1BhdGggPSAoKSA9PiB7XHJcbiAgICBjb25zdCBkb2NQYXRoID0gcGF0aC5qb2luKHV0aWwuZ2V0Vm9ydGV4UGF0aCgnZG9jdW1lbnRzJyksICdUaGUgV2l0Y2hlciAzJyk7XHJcbiAgICB1dGlsLm9wbihkb2NQYXRoKS5jYXRjaCgoKSA9PiBudWxsKTtcclxuICB9O1xyXG5cclxuICBjb25zdCBpc1RXMyA9IChnYW1lSWQgPSB1bmRlZmluZWQpID0+IHtcclxuICAgIGlmIChnYW1lSWQgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICByZXR1cm4gKGdhbWVJZCA9PT0gR0FNRV9JRCk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBzdGF0ZSA9IGNvbnRleHQuYXBpLmdldFN0YXRlKCk7XHJcbiAgICBjb25zdCBnYW1lTW9kZSA9IHNlbGVjdG9ycy5hY3RpdmVHYW1lSWQoc3RhdGUpO1xyXG4gICAgcmV0dXJuIChnYW1lTW9kZSA9PT0gR0FNRV9JRCk7XHJcbiAgfTtcclxuXHJcbiAgY29udGV4dC5yZWdpc3RlckFjdGlvbignbW9kcy1hY3Rpb24taWNvbnMnLCAzMDAsICdzdGFydC1pbnN0YWxsJywge30sICdJbXBvcnQgU2NyaXB0IE1lcmdlcycsXHJcbiAgICBpbnN0YW5jZUlkcyA9PiB7IG1ha2VPbkNvbnRleHRJbXBvcnQoY29udGV4dC5hcGksIGluc3RhbmNlSWRzWzBdKTsgfSxcclxuICAgIGluc3RhbmNlSWRzID0+IHtcclxuICAgICAgY29uc3Qgc3RhdGUgPSBjb250ZXh0LmFwaS5nZXRTdGF0ZSgpO1xyXG4gICAgICBjb25zdCBtb2RzID0gdXRpbC5nZXRTYWZlKHN0YXRlLCBbJ3BlcnNpc3RlbnQnLCAnbW9kcycsIEdBTUVfSURdLCB7fSk7XHJcbiAgICAgIGlmIChtb2RzW2luc3RhbmNlSWRzPy5bMF1dPy50eXBlICE9PSAnY29sbGVjdGlvbicpIHtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgYWN0aXZlR2FtZUlkID0gc2VsZWN0b3JzLmFjdGl2ZUdhbWVJZChzdGF0ZSk7XHJcbiAgICAgIHJldHVybiBhY3RpdmVHYW1lSWQgPT09IEdBTUVfSUQ7XHJcbiAgICB9KTtcclxuXHJcbiAgY29udGV4dC5yZWdpc3RlckFjdGlvbignbW9kLWljb25zJywgNTAwLCAnc2F2ZWdhbWUnLCB7fSwgJ0FwcGx5IE1vZCBMaW1pdCBQYXRjaCcsICgpID0+IHtcclxuICAgIGdldE1vZExpbWl0UGF0Y2hlcigpLmVuc3VyZU1vZExpbWl0UGF0Y2goKVxyXG4gICAgICAuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICBjb250ZXh0LmFwaS5zaG93RXJyb3JOb3RpZmljYXRpb24oJ0ZhaWxlZCB0byBhcHBseSBwYXRjaCcsIGVyciwge1xyXG4gICAgICAgICAgYWxsb3dSZXBvcnQ6IChlcnIgaW5zdGFuY2VvZiB1dGlsLlByb2Nlc3NDYW5jZWxlZCksXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG4gIH0sICgpID0+IHNlbGVjdG9ycy5hY3RpdmVHYW1lSWQoY29udGV4dC5hcGkuZ2V0U3RhdGUoKSkgPT09IEdBTUVfSUQpO1xyXG5cclxuICBjb250ZXh0LnJlZ2lzdGVyQWN0aW9uKCdtb2QtaWNvbnMnLCAzMDAsICdvcGVuLWV4dCcsIHt9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgJ09wZW4gVFczIERvY3VtZW50cyBGb2xkZXInLCBvcGVuVFczRG9jUGF0aCwgaXNUVzMpO1xyXG5cclxuICBjb250ZXh0LnJlZ2lzdGVyQWN0aW9uKCdmYi1sb2FkLW9yZGVyLWljb25zJywgMzAwLCAnb3Blbi1leHQnLCB7fSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICdPcGVuIFRXMyBEb2N1bWVudHMgRm9sZGVyJywgb3BlblRXM0RvY1BhdGgsIGlzVFczKTtcclxuXHJcbiAgY29udGV4dC5yZWdpc3RlckFjdGlvbignZmItbG9hZC1vcmRlci1pY29ucycsIDEwMCwgJ2xvb3Qtc29ydCcsIHt9LCAnU29ydCBieSBEZXBsb3kgT3JkZXInLFxyXG4gICAgKCkgPT4ge1xyXG4gICAgICBjb250ZXh0LmFwaS5zaG93RGlhbG9nKCdpbmZvJywgJ1NvcnQgYnkgRGVwbG95bWVudCBPcmRlcicsIHtcclxuICAgICAgICBiYmNvZGU6IGNvbnRleHQuYXBpLnRyYW5zbGF0ZSgnVGhpcyBhY3Rpb24gd2lsbCBzZXQgcHJpb3JpdGllcyB1c2luZyB0aGUgZGVwbG95bWVudCBydWxlcyAnXHJcbiAgICAgICAgICArICdkZWZpbmVkIGluIHRoZSBtb2RzIHBhZ2UuIEFyZSB5b3Ugc3VyZSB5b3Ugd2lzaCB0byBwcm9jZWVkID9bYnJdWy9icl1bYnJdWy9icl0nXHJcbiAgICAgICAgICArICdQbGVhc2UgYmUgYXdhcmUgdGhhdCBhbnkgZXh0ZXJuYWxseSBhZGRlZCBtb2RzIChhZGRlZCBtYW51YWxseSBvciBieSBvdGhlciB0b29scykgd2lsbCBiZSBwdXNoZWQgJ1xyXG4gICAgICAgICAgKyAndG8gdGhlIGJvdHRvbSBvZiB0aGUgbGlzdCwgd2hpbGUgYWxsIG1vZHMgdGhhdCBoYXZlIGJlZW4gaW5zdGFsbGVkIHRocm91Z2ggVm9ydGV4IHdpbGwgc2hpZnQgJ1xyXG4gICAgICAgICAgKyAnaW4gcG9zaXRpb24gdG8gbWF0Y2ggdGhlIGRlcGxveSBvcmRlciEnLCB7IG5zOiBJMThOX05BTUVTUEFDRSB9KSxcclxuICAgICAgfSwgW1xyXG4gICAgICAgIHsgbGFiZWw6ICdDYW5jZWwnLCBhY3Rpb246ICgpID0+IHtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9fSxcclxuICAgICAgICB7IGxhYmVsOiAnU29ydCBieSBEZXBsb3kgT3JkZXInLCBhY3Rpb246ICgpID0+IHtcclxuICAgICAgICAgIGNvbnN0IHN0YXRlID0gY29udGV4dC5hcGkuZ2V0U3RhdGUoKTtcclxuICAgICAgICAgIGNvbnN0IGdhbWVNb2RzID0gc3RhdGUucGVyc2lzdGVudC5tb2RzPy5bR0FNRV9JRF0gfHwge307XHJcbiAgICAgICAgICBjb25zdCBwcm9maWxlID0gc2VsZWN0b3JzLmFjdGl2ZVByb2ZpbGUoc3RhdGUpO1xyXG4gICAgICAgICAgY29uc3QgbW9kcyA9IE9iamVjdC5rZXlzKGdhbWVNb2RzKVxyXG4gICAgICAgICAgICAuZmlsdGVyKGtleSA9PiB1dGlsLmdldFNhZmUocHJvZmlsZSwgWydtb2RTdGF0ZScsIGtleSwgJ2VuYWJsZWQnXSwgZmFsc2UpKVxyXG4gICAgICAgICAgICAubWFwKGtleSA9PiBnYW1lTW9kc1trZXldKTtcclxuICAgICAgICAgIGNvbnN0IGZpbmRJbmRleCA9IChlbnRyeTogdHlwZXMuSUxvYWRPcmRlckVudHJ5LCBtb2RMaXN0OiB0eXBlcy5JTW9kW10pID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIG1vZExpc3QuZmluZEluZGV4KG0gPT4gbS5pZCA9PT0gZW50cnkubW9kSWQpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIHV0aWwuc29ydE1vZHMoR0FNRV9JRCwgbW9kcywgY29udGV4dC5hcGkpXHJcbiAgICAgICAgICAgIC50aGVuKHNvcnRlZCA9PiB7XHJcbiAgICAgICAgICAgICAgY29uc3QgbG9hZE9yZGVyID0gZ2V0UGVyc2lzdGVudExvYWRPcmRlcihjb250ZXh0LmFwaSk7XHJcbiAgICAgICAgICAgICAgY29uc3QgZmlsdGVyZWQgPSBsb2FkT3JkZXIuZmlsdGVyKGVudHJ5ID0+XHJcbiAgICAgICAgICAgICAgICBzb3J0ZWQuZmluZChtb2QgPT4gbW9kLmlkID09PSBlbnRyeS5pZCkgIT09IHVuZGVmaW5lZCk7XHJcbiAgICAgICAgICAgICAgY29uc3Qgc29ydGVkTE8gPSBmaWx0ZXJlZC5zb3J0KChhLCBiKSA9PiBmaW5kSW5kZXgoYSwgc29ydGVkKSAtIGZpbmRJbmRleChiLCBzb3J0ZWQpKTtcclxuICAgICAgICAgICAgICBjb25zdCBsb2NrZWQgPSBsb2FkT3JkZXIuZmlsdGVyKGVudHJ5ID0+IGVudHJ5Lm5hbWUuaW5jbHVkZXMoTE9DS0VEX1BSRUZJWCkpO1xyXG4gICAgICAgICAgICAgIGNvbnN0IG1hbnVhbGx5QWRkZWQgPSBsb2FkT3JkZXIuZmlsdGVyKGtleSA9PiAhZmlsdGVyZWQuaW5jbHVkZXMoa2V5KSAmJiAhbG9ja2VkLmluY2x1ZGVzKGtleSkpO1xyXG4gICAgICAgICAgICAgIGNvbnN0IG5ld0xPID0gWy4uLmxvY2tlZCwgLi4uc29ydGVkTE8sIC4uLm1hbnVhbGx5QWRkZWRdLnJlZHVjZSgoYWNjdW0sIGVudHJ5LCBpZHgpID0+IHtcclxuICAgICAgICAgICAgICAgIGFjY3VtLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAuLi5lbnRyeSxcclxuICAgICAgICAgICAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgICAgICAgICAgIHByZWZpeDogaWR4ICsgMVxyXG4gICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhY2N1bTtcclxuICAgICAgICAgICAgICB9LCBbXSk7XHJcblxyXG4gICAgICAgICAgICAgIGNvbnRleHQuYXBpLnN0b3JlLmRpc3BhdGNoKGFjdGlvbnMuc2V0TG9hZE9yZGVyKHByb2ZpbGUuaWQsIG5ld0xPIGFzIGFueSkpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICAgICAgICBjb25zdCBhbGxvd1JlcG9ydCA9ICEoZXJyIGluc3RhbmNlb2YgdXRpbC5DeWNsZUVycm9yKTtcclxuICAgICAgICAgICAgICBjb250ZXh0LmFwaS5zaG93RXJyb3JOb3RpZmljYXRpb24oJ0ZhaWxlZCB0byBzb3J0IGJ5IGRlcGxveW1lbnQgb3JkZXInLCBlcnIsXHJcbiAgICAgICAgICAgICAgICB7IGFsbG93UmVwb3J0IH0pO1xyXG4gICAgICAgICAgICB9KS5maW5hbGx5KCgpID0+IHtcclxuICAgICAgICAgICAgICBmb3JjZVJlZnJlc2goY29udGV4dC5hcGkpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9fSxcclxuICAgICAgXSk7XHJcbiAgICB9LCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHN0YXRlID0gY29udGV4dC5hcGkuc3RvcmUuZ2V0U3RhdGUoKTtcclxuICAgICAgY29uc3QgZ2FtZU1vZGUgPSBzZWxlY3RvcnMuYWN0aXZlR2FtZUlkKHN0YXRlKTtcclxuICAgICAgcmV0dXJuIGdhbWVNb2RlID09PSBHQU1FX0lEO1xyXG4gICAgfSk7XHJcbn07XHJcbiJdfQ==