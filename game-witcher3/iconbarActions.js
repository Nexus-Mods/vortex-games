"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.registerActions = void 0;
const path_1 = __importDefault(require("path"));
const vortex_api_1 = require("vortex-api");
const common_1 = require("./common");
const PriorityTypeButton_1 = __importDefault(require("./views/PriorityTypeButton"));
const mergeBackup_1 = require("./mergeBackup");
const util_1 = require("./util");
const migrations_1 = require("./migrations");
function resetPriorities(props) {
    const { context } = props;
    const state = context.api.getState();
    const profile = vortex_api_1.selectors.activeProfile(state);
    const loadOrder = (0, migrations_1.getPersistentLoadOrder)(context.api);
    const newLO = loadOrder.reduce((accum, loEntry, idx) => {
        accum.push(Object.assign(Object.assign({}, loEntry), { data: { prefix: idx + 1 } }));
        return accum;
    }, []);
    context.api.store.dispatch(vortex_api_1.actions.setLoadOrder(profile.id, newLO));
    (0, util_1.forceRefresh)(context.api);
    return newLO;
}
const registerActions = (props) => {
    const { context, getModLimitPatcher } = props;
    const openTW3DocPath = () => {
        const docPath = path_1.default.join(vortex_api_1.util.getVortexPath('documents'), 'The Witcher 3');
        vortex_api_1.util.opn(docPath).catch(() => null);
    };
    const isTW3 = (gameId = undefined) => {
        if (gameId !== undefined) {
            return (gameId === common_1.GAME_ID);
        }
        const state = context.api.getState();
        const gameMode = vortex_api_1.selectors.activeGameId(state);
        return (gameMode === common_1.GAME_ID);
    };
    context.registerAction('mods-action-icons', 300, 'start-install', {}, 'Import Script Merges', instanceIds => { (0, mergeBackup_1.makeOnContextImport)(context.api, instanceIds[0]); }, instanceIds => {
        var _a;
        const state = context.api.getState();
        const mods = vortex_api_1.util.getSafe(state, ['persistent', 'mods', common_1.GAME_ID], {});
        if (((_a = mods[instanceIds === null || instanceIds === void 0 ? void 0 : instanceIds[0]]) === null || _a === void 0 ? void 0 : _a.type) !== 'collection') {
            return false;
        }
        const activeGameId = vortex_api_1.selectors.activeGameId(state);
        return activeGameId === common_1.GAME_ID;
    });
    context.registerAction('mod-icons', 500, 'savegame', {}, 'Apply Mod Limit Patch', () => {
        getModLimitPatcher().ensureModLimitPatch()
            .catch(err => {
            context.api.showErrorNotification('Failed to apply patch', err, {
                allowReport: (err instanceof vortex_api_1.util.ProcessCanceled),
            });
        });
    }, () => vortex_api_1.selectors.activeGameId(context.api.getState()) === common_1.GAME_ID);
    context.registerAction('generic-load-order-icons', 300, PriorityTypeButton_1.default, {}, undefined, isTW3);
    context.registerAction('mod-icons', 300, 'open-ext', {}, 'Open TW3 Documents Folder', openTW3DocPath, isTW3);
    context.registerAction('generic-load-order-icons', 300, 'open-ext', {}, 'Open TW3 Documents Folder', openTW3DocPath, isTW3);
    context.registerAction('generic-load-order-icons', 100, 'loot-sort', {}, 'Reset Priorities', () => {
        context.api.showDialog('info', 'Reset Priorities', {
            bbcode: context.api.translate('This action will revert all manually set priorities and will re-instate priorities in an incremental '
                + 'manner starting from 1. Are you sure you want to do this ?', { ns: common_1.I18N_NAMESPACE }),
        }, [
            { label: 'Cancel', action: () => {
                    return;
                } },
            { label: 'Reset Priorities', action: () => resetPriorities(props) },
        ]);
    }, () => {
        const state = context.api.store.getState();
        const gameMode = vortex_api_1.selectors.activeGameId(state);
        return gameMode === common_1.GAME_ID;
    });
    context.registerAction('generic-load-order-icons', 100, 'loot-sort', {}, 'Sort by Deploy Order', () => {
        context.api.showDialog('info', 'Sort by Deployment Order', {
            bbcode: context.api.translate('This action will set priorities using the deployment rules '
                + 'defined in the mods page. Are you sure you wish to proceed ?[br][/br][br][/br]'
                + 'Please be aware that any externally added mods (added manually or by other tools) will be pushed '
                + 'to the bottom of the list, while all mods that have been installed through Vortex will shift '
                + 'in position to match the deploy order!', { ns: common_1.I18N_NAMESPACE }),
        }, [
            { label: 'Cancel', action: () => {
                    return;
                } },
            { label: 'Sort by Deploy Order', action: () => {
                    var _a;
                    const state = context.api.getState();
                    const gameMods = ((_a = state.persistent.mods) === null || _a === void 0 ? void 0 : _a[common_1.GAME_ID]) || {};
                    const profile = vortex_api_1.selectors.activeProfile(state);
                    const mods = Object.keys(gameMods)
                        .filter(key => vortex_api_1.util.getSafe(profile, ['modState', key, 'enabled'], false))
                        .map(key => gameMods[key]);
                    const findIndex = (entry, modList) => {
                        return modList.findIndex(m => m.id === entry.modId);
                    };
                    return vortex_api_1.util.sortMods(common_1.GAME_ID, mods, context.api)
                        .then(sorted => {
                        const loadOrder = (0, migrations_1.getPersistentLoadOrder)(context.api);
                        const filtered = loadOrder.filter(entry => sorted.find(mod => mod.id === entry.id) !== undefined);
                        const sortedLO = filtered.sort((a, b) => findIndex(a, sorted) - findIndex(b, sorted));
                        const locked = loadOrder.filter(entry => entry.name.includes(common_1.LOCKED_PREFIX));
                        const manuallyAdded = loadOrder.filter(key => !filtered.includes(key) && !locked.includes(key));
                        const newLO = [...locked, ...sortedLO, ...manuallyAdded].reduce((accum, entry, idx) => {
                            accum.push(Object.assign(Object.assign({}, entry), { data: {
                                    prefix: idx + 1
                                } }));
                            return accum;
                        }, []);
                        context.api.store.dispatch(vortex_api_1.actions.setLoadOrder(profile.id, newLO));
                    })
                        .catch(err => {
                        const allowReport = !(err instanceof vortex_api_1.util.CycleError);
                        context.api.showErrorNotification('Failed to sort by deployment order', err, { allowReport });
                    }).finally(() => {
                        (0, util_1.forceRefresh)(context.api);
                    });
                } },
        ]);
    }, () => {
        const state = context.api.store.getState();
        const gameMode = vortex_api_1.selectors.activeGameId(state);
        return gameMode === common_1.GAME_ID;
    });
};
exports.registerActions = registerActions;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWNvbmJhckFjdGlvbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpY29uYmFyQWN0aW9ucy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFDQSxnREFBd0I7QUFDeEIsMkNBQTZEO0FBRTdELHFDQUFrRTtBQUdsRSxvRkFBNEQ7QUFFNUQsK0NBQW9EO0FBR3BELGlDQUFzQztBQUN0Qyw2Q0FBc0Q7QUFRdEQsU0FBUyxlQUFlLENBQUMsS0FBYTtJQUNwQyxNQUFNLEVBQUUsT0FBTyxFQUFFLEdBQUcsS0FBSyxDQUFDO0lBQzFCLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDckMsTUFBTSxPQUFPLEdBQUcsc0JBQVMsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDL0MsTUFBTSxTQUFTLEdBQW9CLElBQUEsbUNBQXNCLEVBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3ZFLE1BQU0sS0FBSyxHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxFQUFFO1FBQ3JELEtBQUssQ0FBQyxJQUFJLGlDQUFNLE9BQU8sS0FBRSxJQUFJLEVBQUUsRUFBRSxNQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsRUFBRSxJQUFHLENBQUM7UUFDdEQsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDUCxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsb0JBQU8sQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRSxLQUFZLENBQUMsQ0FBQyxDQUFDO0lBQzNFLElBQUEsbUJBQVksRUFBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDMUIsT0FBTyxLQUFLLENBQUM7QUFDZixDQUFDO0FBRU0sTUFBTSxlQUFlLEdBQUcsQ0FBQyxLQUFhLEVBQUUsRUFBRTtJ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LEVBQUUsR0FBRyxHQUFHLENBQUM7aUNBQ2hCLElBQ0QsQ0FBQzs0QkFDSCxPQUFPLEtBQUssQ0FBQzt3QkFDZixDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7d0JBRVAsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLG9CQUFPLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxFQUFFLEVBQUUsS0FBWSxDQUFDLENBQUMsQ0FBQztvQkFDN0UsQ0FBQyxDQUFDO3lCQUNELEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRTt3QkFDWCxNQUFNLFdBQVcsR0FBRyxDQUFDLENBQUMsR0FBRyxZQUFZLGlCQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7d0JBQ3RELE9BQU8sQ0FBQyxHQUFHLENBQUMscUJBQXFCLENBQUMsb0NBQW9DLEVBQUUsR0FBRyxFQUN6RSxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUM7b0JBQ3JCLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUU7d0JBQ2QsSUFBQSxtQkFBWSxFQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztvQkFDNUIsQ0FBQyxDQUFDLENBQUM7Z0JBQ1AsQ0FBQyxFQUFDO1NBQ0gsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxFQUFFLEdBQUcsRUFBRTtRQUNOLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQzNDLE1BQU0sUUFBUSxHQUFHLHNCQUFTLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQy9DLE9BQU8sUUFBUSxLQUFLLGdCQUFPLENBQUM7SUFDOUIsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUM7QUF2SFcsUUFBQSxlQUFlLG1CQXVIMUIiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSAqL1xyXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcclxuaW1wb3J0IHsgYWN0aW9ucywgc2VsZWN0b3JzLCB0eXBlcywgdXRpbCB9IGZyb20gJ3ZvcnRleC1hcGknO1xyXG5cclxuaW1wb3J0IHsgR0FNRV9JRCwgSTE4Tl9OQU1FU1BBQ0UsIExPQ0tFRF9QUkVGSVggfSBmcm9tICcuL2NvbW1vbic7XHJcbmltcG9ydCB7IFByaW9yaXR5TWFuYWdlciB9IGZyb20gJy4vcHJpb3JpdHlNYW5hZ2VyJztcclxuXHJcbmltcG9ydCBQcmlvcml0eVR5cGVCdXR0b24gZnJvbSAnLi92aWV3cy9Qcmlvcml0eVR5cGVCdXR0b24nO1xyXG5cclxuaW1wb3J0IHsgbWFrZU9uQ29udGV4dEltcG9ydCB9IGZyb20gJy4vbWVyZ2VCYWNrdXAnO1xyXG5pbXBvcnQgeyBNb2RMaW1pdFBhdGNoZXIgfSBmcm9tICcuL21vZExpbWl0UGF0Y2gnO1xyXG5cclxuaW1wb3J0IHsgZm9yY2VSZWZyZXNoIH0gZnJvbSAnLi91dGlsJztcclxuaW1wb3J0IHsgZ2V0UGVyc2lzdGVudExvYWRPcmRlciB9IGZyb20gJy4vbWlncmF0aW9ucyc7XHJcblxyXG5pbnRlcmZhY2UgSVByb3BzIHtcclxuICBjb250ZXh0OiB0eXBlcy5JRXh0ZW5zaW9uQ29udGV4dDtcclxuICBnZXRQcmlvcml0eU1hbmFnZXI6ICgpID0+IFByaW9yaXR5TWFuYWdlcjtcclxuICBnZXRNb2RMaW1pdFBhdGNoZXI6ICgpID0+IE1vZExpbWl0UGF0Y2hlcjtcclxufVxyXG5cclxuZnVuY3Rpb24gcmVzZXRQcmlvcml0aWVzKHByb3BzOiBJUHJvcHMpIHtcclxuICBjb25zdCB7IGNvbnRleHQgfSA9IHByb3BzO1xyXG4gIGNvbnN0IHN0YXRlID0gY29udGV4dC5hcGkuZ2V0U3RhdGUoKTtcclxuICBjb25zdCBwcm9maWxlID0gc2VsZWN0b3JzLmFjdGl2ZVByb2ZpbGUoc3RhdGUpO1xyXG4gIGNvbnN0IGxvYWRPcmRlcjogdHlwZXMuTG9hZE9yZGVyID0gZ2V0UGVyc2lzdGVudExvYWRPcmRlcihjb250ZXh0LmFwaSk7XHJcbiAgY29uc3QgbmV3TE8gPSBsb2FkT3JkZXIucmVkdWNlKChhY2N1bSwgbG9FbnRyeSwgaWR4KSA9PiB7XHJcbiAgICBhY2N1bS5wdXNoKHsgLi4ubG9FbnRyeSwgZGF0YTogeyBwcmVmaXg6IGlkeCArIDEgfSB9KTtcclxuICAgIHJldHVybiBhY2N1bTtcclxuICB9LCBbXSk7XHJcbiAgY29udGV4dC5hcGkuc3RvcmUuZGlzcGF0Y2goYWN0aW9ucy5zZXRMb2FkT3JkZXIocHJvZmlsZS5pZCwgbmV3TE8gYXMgYW55KSk7XHJcbiAgZm9yY2VSZWZyZXNoKGNvbnRleHQuYXBpKTtcclxuICByZXR1cm4gbmV3TE87XHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCByZWdpc3RlckFjdGlvbnMgPSAocHJvcHM6IElQcm9wcykgPT4ge1xyXG4gIGNvbnN0IHsgY29udGV4dCwgZ2V0TW9kTGltaXRQYXRjaGVyIH0gPSBwcm9wcztcclxuICBjb25zdCBvcGVuVFczRG9jUGF0aCA9ICgpID0+IHtcclxuICAgIGNvbnN0IGRvY1BhdGggPSBwYXRoLmpvaW4odXRpbC5nZXRWb3J0ZXhQYXRoKCdkb2N1bWVudHMnKSwgJ1RoZSBXaXRjaGVyIDMnKTtcclxuICAgIHV0aWwub3BuKGRvY1BhdGgpLmNhdGNoKCgpID0+IG51bGwpO1xyXG4gIH07XHJcblxyXG4gIGNvbnN0IGlzVFczID0gKGdhbWVJZCA9IHVuZGVmaW5lZCkgPT4ge1xyXG4gICAgaWYgKGdhbWVJZCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIHJldHVybiAoZ2FtZUlkID09PSBHQU1FX0lEKTtcclxuICAgIH1cclxuICAgIGNvbnN0IHN0YXRlID0gY29udGV4dC5hcGkuZ2V0U3RhdGUoKTtcclxuICAgIGNvbnN0IGdhbWVNb2RlID0gc2VsZWN0b3JzLmFjdGl2ZUdhbWVJZChzdGF0ZSk7XHJcbiAgICByZXR1cm4gKGdhbWVNb2RlID09PSBHQU1FX0lEKTtcclxuICB9O1xyXG5cclxuICBjb250ZXh0LnJlZ2lzdGVyQWN0aW9uKCdtb2RzLWFjdGlvbi1pY29ucycsIDMwMCwgJ3N0YXJ0LWluc3RhbGwnLCB7fSwgJ0ltcG9ydCBTY3JpcHQgTWVyZ2VzJyxcclxuICAgIGluc3RhbmNlSWRzID0+IHsgbWFrZU9uQ29udGV4dEltcG9ydChjb250ZXh0LmFwaSwgaW5zdGFuY2VJZHNbMF0pOyB9LFxyXG4gICAgaW5zdGFuY2VJZHMgPT4ge1xyXG4gICAgICBjb25zdCBzdGF0ZSA9IGNvbnRleHQuYXBpLmdldFN0YXRlKCk7XHJcbiAgICAgIGNvbnN0IG1vZHMgPSB1dGlsLmdldFNhZmUoc3RhdGUsIFsncGVyc2lzdGVudCcsICdtb2RzJywgR0FNRV9JRF0sIHt9KTtcclxuICAgICAgaWYgKG1vZHNbaW5zdGFuY2VJZHM/LlswXV0/LnR5cGUgIT09ICdjb2xsZWN0aW9uJykge1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBhY3RpdmVHYW1lSWQgPSBzZWxlY3RvcnMuYWN0aXZlR2FtZUlkKHN0YXRlKTtcclxuICAgICAgcmV0dXJuIGFjdGl2ZUdhbWVJZCA9PT0gR0FNRV9JRDtcclxuICAgIH0pO1xyXG5cclxuICBjb250ZXh0LnJlZ2lzdGVyQWN0aW9uKCdtb2QtaWNvbnMnLCA1MDAsICdzYXZlZ2FtZScsIHt9LCAnQXBwbHkgTW9kIExpbWl0IFBhdGNoJywgKCkgPT4ge1xyXG4gICAgZ2V0TW9kTGltaXRQYXRjaGVyKCkuZW5zdXJlTW9kTGltaXRQYXRjaCgpXHJcbiAgICAgIC5jYXRjaChlcnIgPT4ge1xyXG4gICAgICAgIGNvbnRleHQuYXBpLnNob3dFcnJvck5vdGlmaWNhdGlvbignRmFpbGVkIHRvIGFwcGx5IHBhdGNoJywgZXJyLCB7XHJcbiAgICAgICAgICBhbGxvd1JlcG9ydDogKGVyciBpbnN0YW5jZW9mIHV0aWwuUHJvY2Vzc0NhbmNlbGVkKSxcclxuICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcbiAgfSwgKCkgPT4gc2VsZWN0b3JzLmFjdGl2ZUdhbWVJZChjb250ZXh0LmFwaS5nZXRTdGF0ZSgpKSA9PT0gR0FNRV9JRCk7XHJcblxyXG4gIGNvbnRleHQucmVnaXN0ZXJBY3Rpb24oJ2dlbmVyaWMtbG9hZC1vcmRlci1pY29ucycsIDMwMCwgUHJpb3JpdHlUeXBlQnV0dG9uLCB7fSxcclxuICAgIHVuZGVmaW5lZCwgaXNUVzMpO1xyXG5cclxuICBjb250ZXh0LnJlZ2lzdGVyQWN0aW9uKCdtb2QtaWNvbnMnLCAzMDAsICdvcGVuLWV4dCcsIHt9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgJ09wZW4gVFczIERvY3VtZW50cyBGb2xkZXInLCBvcGVuVFczRG9jUGF0aCwgaXNUVzMpO1xyXG5cclxuICBjb250ZXh0LnJlZ2lzdGVyQWN0aW9uKCdnZW5lcmljLWxvYWQtb3JkZXItaWNvbnMnLCAzMDAsICdvcGVuLWV4dCcsIHt9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgJ09wZW4gVFczIERvY3VtZW50cyBGb2xkZXInLCBvcGVuVFczRG9jUGF0aCwgaXNUVzMpO1xyXG5cclxuICBjb250ZXh0LnJlZ2lzdGVyQWN0aW9uKCdnZW5lcmljLWxvYWQtb3JkZXItaWNvbnMnLCAxMDAsICdsb290LXNvcnQnLCB7fSwgJ1Jlc2V0IFByaW9yaXRpZXMnLFxyXG4gICAgKCkgPT4ge1xyXG4gICAgICBjb250ZXh0LmFwaS5zaG93RGlhbG9nKCdpbmZvJywgJ1Jlc2V0IFByaW9yaXRpZXMnLCB7XHJcbiAgICAgICAgYmJjb2RlOiBjb250ZXh0LmFwaS50cmFuc2xhdGUoJ1RoaXMgYWN0aW9uIHdpbGwgcmV2ZXJ0IGFsbCBtYW51YWxseSBzZXQgcHJpb3JpdGllcyBhbmQgd2lsbCByZS1pbnN0YXRlIHByaW9yaXRpZXMgaW4gYW4gaW5jcmVtZW50YWwgJ1xyXG4gICAgICAgICAgKyAnbWFubmVyIHN0YXJ0aW5nIGZyb20gMS4gQXJlIHlvdSBzdXJlIHlvdSB3YW50IHRvIGRvIHRoaXMgPycsIHsgbnM6IEkxOE5fTkFNRVNQQUNFIH0pLFxyXG4gICAgICB9LCBbXHJcbiAgICAgICAgeyBsYWJlbDogJ0NhbmNlbCcsIGFjdGlvbjogKCkgPT4ge1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH19LFxyXG4gICAgICAgIHsgbGFiZWw6ICdSZXNldCBQcmlvcml0aWVzJywgYWN0aW9uOiAoKSA9PiByZXNldFByaW9yaXRpZXMocHJvcHMpIH0sXHJcbiAgICAgIF0pO1xyXG4gICAgfSwgKCkgPT4ge1xyXG4gICAgICBjb25zdCBzdGF0ZSA9IGNvbnRleHQuYXBpLnN0b3JlLmdldFN0YXRlKCk7XHJcbiAgICAgIGNvbnN0IGdhbWVNb2RlID0gc2VsZWN0b3JzLmFjdGl2ZUdhbWVJZChzdGF0ZSk7XHJcbiAgICAgIHJldHVybiBnYW1lTW9kZSA9PT0gR0FNRV9JRDtcclxuICAgIH0pO1xyXG5cclxuICBjb250ZXh0LnJlZ2lzdGVyQWN0aW9uKCdnZW5lcmljLWxvYWQtb3JkZXItaWNvbnMnLCAxMDAsICdsb290LXNvcnQnLCB7fSwgJ1NvcnQgYnkgRGVwbG95IE9yZGVyJyxcclxuICAgICgpID0+IHtcclxuICAgICAgY29udGV4dC5hcGkuc2hvd0RpYWxvZygnaW5mbycsICdTb3J0IGJ5IERlcGxveW1lbnQgT3JkZXInLCB7XHJcbiAgICAgICAgYmJjb2RlOiBjb250ZXh0LmFwaS50cmFuc2xhdGUoJ1RoaXMgYWN0aW9uIHdpbGwgc2V0IHByaW9yaXRpZXMgdXNpbmcgdGhlIGRlcGxveW1lbnQgcnVsZXMgJ1xyXG4gICAgICAgICAgKyAnZGVmaW5lZCBpbiB0aGUgbW9kcyBwYWdlLiBBcmUgeW91IHN1cmUgeW91IHdpc2ggdG8gcHJvY2VlZCA/W2JyXVsvYnJdW2JyXVsvYnJdJ1xyXG4gICAgICAgICAgKyAnUGxlYXNlIGJlIGF3YXJlIHRoYXQgYW55IGV4dGVybmFsbHkgYWRkZWQgbW9kcyAoYWRkZWQgbWFudWFsbHkgb3IgYnkgb3RoZXIgdG9vbHMpIHdpbGwgYmUgcHVzaGVkICdcclxuICAgICAgICAgICsgJ3RvIHRoZSBib3R0b20gb2YgdGhlIGxpc3QsIHdoaWxlIGFsbCBtb2RzIHRoYXQgaGF2ZSBiZWVuIGluc3RhbGxlZCB0aHJvdWdoIFZvcnRleCB3aWxsIHNoaWZ0ICdcclxuICAgICAgICAgICsgJ2luIHBvc2l0aW9uIHRvIG1hdGNoIHRoZSBkZXBsb3kgb3JkZXIhJywgeyBuczogSTE4Tl9OQU1FU1BBQ0UgfSksXHJcbiAgICAgIH0sIFtcclxuICAgICAgICB7IGxhYmVsOiAnQ2FuY2VsJywgYWN0aW9uOiAoKSA9PiB7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfX0sXHJcbiAgICAgICAgeyBsYWJlbDogJ1NvcnQgYnkgRGVwbG95IE9yZGVyJywgYWN0aW9uOiAoKSA9PiB7XHJcbiAgICAgICAgICBjb25zdCBzdGF0ZSA9IGNvbnRleHQuYXBpLmdldFN0YXRlKCk7XHJcbiAgICAgICAgICBjb25zdCBnYW1lTW9kcyA9IHN0YXRlLnBlcnNpc3RlbnQubW9kcz8uW0dBTUVfSURdIHx8IHt9O1xyXG4gICAgICAgICAgY29uc3QgcHJvZmlsZSA9IHNlbGVjdG9ycy5hY3RpdmVQcm9maWxlKHN0YXRlKTtcclxuICAgICAgICAgIGNvbnN0IG1vZHMgPSBPYmplY3Qua2V5cyhnYW1lTW9kcylcclxuICAgICAgICAgICAgLmZpbHRlcihrZXkgPT4gdXRpbC5nZXRTYWZlKHByb2ZpbGUsIFsnbW9kU3RhdGUnLCBrZXksICdlbmFibGVkJ10sIGZhbHNlKSlcclxuICAgICAgICAgICAgLm1hcChrZXkgPT4gZ2FtZU1vZHNba2V5XSk7XHJcbiAgICAgICAgICBjb25zdCBmaW5kSW5kZXggPSAoZW50cnk6IHR5cGVzLklMb2FkT3JkZXJFbnRyeSwgbW9kTGlzdDogdHlwZXMuSU1vZFtdKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBtb2RMaXN0LmZpbmRJbmRleChtID0+IG0uaWQgPT09IGVudHJ5Lm1vZElkKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHJldHVybiB1dGlsLnNvcnRNb2RzKEdBTUVfSUQsIG1vZHMsIGNvbnRleHQuYXBpKVxyXG4gICAgICAgICAgICAudGhlbihzb3J0ZWQgPT4ge1xyXG4gICAgICAgICAgICAgIGNvbnN0IGxvYWRPcmRlciA9IGdldFBlcnNpc3RlbnRMb2FkT3JkZXIoY29udGV4dC5hcGkpO1xyXG4gICAgICAgICAgICAgIGNvbnN0IGZpbHRlcmVkID0gbG9hZE9yZGVyLmZpbHRlcihlbnRyeSA9PlxyXG4gICAgICAgICAgICAgICAgc29ydGVkLmZpbmQobW9kID0+IG1vZC5pZCA9PT0gZW50cnkuaWQpICE9PSB1bmRlZmluZWQpO1xyXG4gICAgICAgICAgICAgIGNvbnN0IHNvcnRlZExPID0gZmlsdGVyZWQuc29ydCgoYSwgYikgPT4gZmluZEluZGV4KGEsIHNvcnRlZCkgLSBmaW5kSW5kZXgoYiwgc29ydGVkKSk7XHJcbiAgICAgICAgICAgICAgY29uc3QgbG9ja2VkID0gbG9hZE9yZGVyLmZpbHRlcihlbnRyeSA9PiBlbnRyeS5uYW1lLmluY2x1ZGVzKExPQ0tFRF9QUkVGSVgpKTtcclxuICAgICAgICAgICAgICBjb25zdCBtYW51YWxseUFkZGVkID0gbG9hZE9yZGVyLmZpbHRlcihrZXkgPT4gIWZpbHRlcmVkLmluY2x1ZGVzKGtleSkgJiYgIWxvY2tlZC5pbmNsdWRlcyhrZXkpKTtcclxuICAgICAgICAgICAgICBjb25zdCBuZXdMTyA9IFsuLi5sb2NrZWQsIC4uLnNvcnRlZExPLCAuLi5tYW51YWxseUFkZGVkXS5yZWR1Y2UoKGFjY3VtLCBlbnRyeSwgaWR4KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBhY2N1bS5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgLi4uZW50cnksXHJcbiAgICAgICAgICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgICAgICAgICBwcmVmaXg6IGlkeCArIDFcclxuICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYWNjdW07XHJcbiAgICAgICAgICAgICAgfSwgW10pO1xyXG5cclxuICAgICAgICAgICAgICBjb250ZXh0LmFwaS5zdG9yZS5kaXNwYXRjaChhY3Rpb25zLnNldExvYWRPcmRlcihwcm9maWxlLmlkLCBuZXdMTyBhcyBhbnkpKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgY29uc3QgYWxsb3dSZXBvcnQgPSAhKGVyciBpbnN0YW5jZW9mIHV0aWwuQ3ljbGVFcnJvcik7XHJcbiAgICAgICAgICAgICAgY29udGV4dC5hcGkuc2hvd0Vycm9yTm90aWZpY2F0aW9uKCdGYWlsZWQgdG8gc29ydCBieSBkZXBsb3ltZW50IG9yZGVyJywgZXJyLFxyXG4gICAgICAgICAgICAgICAgeyBhbGxvd1JlcG9ydCB9KTtcclxuICAgICAgICAgICAgfSkuZmluYWxseSgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgZm9yY2VSZWZyZXNoKGNvbnRleHQuYXBpKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfX0sXHJcbiAgICAgIF0pO1xyXG4gICAgfSwgKCkgPT4ge1xyXG4gICAgICBjb25zdCBzdGF0ZSA9IGNvbnRleHQuYXBpLnN0b3JlLmdldFN0YXRlKCk7XHJcbiAgICAgIGNvbnN0IGdhbWVNb2RlID0gc2VsZWN0b3JzLmFjdGl2ZUdhbWVJZChzdGF0ZSk7XHJcbiAgICAgIHJldHVybiBnYW1lTW9kZSA9PT0gR0FNRV9JRDtcclxuICAgIH0pO1xyXG59O1xyXG4iXX0=