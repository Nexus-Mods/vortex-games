"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.registerActions = void 0;
const path_1 = __importDefault(require("path"));
const vortex_api_1 = require("vortex-api");
const common_1 = require("./common");
const PriorityTypeButton_1 = __importDefault(require("./views/PriorityTypeButton"));
const mergeBackup_1 = require("./mergeBackup");
function resetPriorities(props) {
    const { context, refreshFunc } = props;
    const state = context.api.getState();
    const profile = vortex_api_1.selectors.activeProfile(state);
    const loadOrder = vortex_api_1.util.getSafe(state, ['persistent', 'loadOrder', profile.id], {});
    const newLO = Object.keys(loadOrder).reduce((accum, key) => {
        const loEntry = loadOrder[key];
        accum[key] = Object.assign(Object.assign({}, loEntry), { prefix: loEntry.pos + 1 });
        return accum;
    }, {});
    context.api.store.dispatch(vortex_api_1.actions.setLoadOrder(profile.id, newLO));
    if (refreshFunc !== undefined) {
        refreshFunc();
    }
    return newLO;
}
const registerActions = (props) => {
    const { context, refreshFunc, getModLimitPatcher } = props;
    const openTW3DocPath = () => {
        const docPath = path_1.default.join(vortex_api_1.util.getVortexPath('documents'), 'The Witcher 3');
        vortex_api_1.util.opn(docPath).catch(() => null);
    };
    const isTW3 = (gameId = undefined) => {
        if (gameId !== undefined) {
            return (gameId === common_1.GAME_ID);
        }
        const state = context.api.getState();
        const gameMode = vortex_api_1.selectors.activeGameId(state);
        return (gameMode === common_1.GAME_ID);
    };
    context.registerAction('mods-action-icons', 300, 'start-install', {}, 'Import Script Merges', instanceIds => { (0, mergeBackup_1.makeOnContextImport)(context, instanceIds[0]); }, instanceIds => {
        var _a;
        const state = context.api.getState();
        const mods = vortex_api_1.util.getSafe(state, ['persistent', 'mods', common_1.GAME_ID], {});
        if (((_a = mods[instanceIds === null || instanceIds === void 0 ? void 0 : instanceIds[0]]) === null || _a === void 0 ? void 0 : _a.type) !== 'collection') {
            return false;
        }
        const activeGameId = vortex_api_1.selectors.activeGameId(state);
        return activeGameId === common_1.GAME_ID;
    });
    context.registerAction('mod-icons', 500, 'savegame', {}, 'Apply Mod Limit Patch', () => {
        getModLimitPatcher().ensureModLimitPatch()
            .catch(err => {
            context.api.showErrorNotification('Failed to apply patch', err, {
                allowReport: (err instanceof vortex_api_1.util.ProcessCanceled),
            });
        });
    }, () => vortex_api_1.selectors.activeGameId(context.api.getState()) === common_1.GAME_ID);
    context.registerAction('generic-load-order-icons', 300, PriorityTypeButton_1.default, {}, undefined, isTW3);
    context.registerAction('mod-icons', 300, 'open-ext', {}, 'Open TW3 Documents Folder', openTW3DocPath, isTW3);
    context.registerAction('generic-load-order-icons', 300, 'open-ext', {}, 'Open TW3 Documents Folder', openTW3DocPath, isTW3);
    context.registerAction('generic-load-order-icons', 100, 'loot-sort', {}, 'Reset Priorities', () => {
        context.api.showDialog('info', 'Reset Priorities', {
            bbcode: context.api.translate('This action will revert all manually set priorities and will re-instate priorities in an incremental '
                + 'manner starting from 1. Are you sure you want to do this ?', { ns: common_1.I18N_NAMESPACE }),
        }, [
            { label: 'Cancel', action: () => {
                    return;
                } },
            { label: 'Reset Priorities', action: () => resetPriorities(props) },
        ]);
    }, () => {
        const state = context.api.store.getState();
        const gameMode = vortex_api_1.selectors.activeGameId(state);
        return gameMode === common_1.GAME_ID;
    });
    context.registerAction('generic-load-order-icons', 100, 'loot-sort', {}, 'Sort by Deploy Order', () => {
        context.api.showDialog('info', 'Sort by Deployment Order', {
            bbcode: context.api.translate('This action will set priorities using the deployment rules '
                + 'defined in the mods page. Are you sure you wish to proceed ?[br][/br][br][/br]'
                + 'Please be aware that any externally added mods (added manually or by other tools) will be pushed '
                + 'to the bottom of the list, while all mods that have been installed through Vortex will shift '
                + 'in position to match the deploy order!', { ns: common_1.I18N_NAMESPACE }),
        }, [
            { label: 'Cancel', action: () => {
                    return;
                } },
            { label: 'Sort by Deploy Order', action: () => {
                    const state = context.api.getState();
                    const gameMods = state.persistent.mods[common_1.GAME_ID] || {};
                    const profile = vortex_api_1.selectors.activeProfile(state);
                    const mods = Object.keys(gameMods)
                        .filter(key => vortex_api_1.util.getSafe(profile, ['modState', key, 'enabled'], false))
                        .map(key => gameMods[key]);
                    return vortex_api_1.util.sortMods(common_1.GAME_ID, mods, context.api)
                        .then(sorted => {
                        const loadOrder = vortex_api_1.util.getSafe(state, ['persistent', 'loadOrder', profile.id], {});
                        const filtered = Object.keys(loadOrder).filter(key => sorted.find(mod => mod.id === key) !== undefined);
                        const manuallyAdded = Object.keys(loadOrder).filter(key => !filtered.includes(key));
                        const minimumIdx = manuallyAdded
                            .filter(key => key.includes(common_1.LOCKED_PREFIX))
                            .reduce((min, key) => {
                            if (min <= loadOrder[key].pos) {
                                min = loadOrder[key].pos + 1;
                            }
                            return min;
                        }, 0);
                        const manualLO = manuallyAdded.reduce((accum, key, idx) => {
                            if (key.includes(common_1.LOCKED_PREFIX)) {
                                accum[key] = loadOrder[key];
                                return accum;
                            }
                            const minimumPosition = (filtered.length + minimumIdx + 1);
                            if (loadOrder[key].pos < minimumPosition) {
                                accum[key] = Object.assign(Object.assign({}, loadOrder[key]), { pos: loadOrder[key].pos + (minimumPosition + idx), prefix: loadOrder[key].pos + (minimumPosition + idx + 1) });
                                return accum;
                            }
                            else {
                                accum[key] = loadOrder[key];
                                return accum;
                            }
                        }, {});
                        const newLO = filtered.reduce((accum, key) => {
                            const loEntry = loadOrder[key];
                            const idx = sorted.findIndex(mod => mod.id === key);
                            const assignedIdx = minimumIdx + idx;
                            accum[key] = Object.assign(Object.assign({}, loEntry), { pos: assignedIdx, prefix: assignedIdx + 1 });
                            return accum;
                        }, manualLO);
                        context.api.store.dispatch(vortex_api_1.actions.setLoadOrder(profile.id, newLO));
                        if (refreshFunc !== undefined) {
                            refreshFunc();
                        }
                    })
                        .catch(err => {
                        const allowReport = !(err instanceof vortex_api_1.util.CycleError);
                        context.api.showErrorNotification('Failed to sort by deployment order', err, { allowReport });
                    });
                } },
        ]);
    }, () => {
        const state = context.api.store.getState();
        const gameMode = vortex_api_1.selectors.activeGameId(state);
        return gameMode === common_1.GAME_ID;
    });
};
exports.registerActions = registerActions;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWNvbmJhckFjdGlvbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpY29uYmFyQWN0aW9ucy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxnREFBd0I7QUFDeEIsMkNBQWlFO0FBR2pFLHFDQUF5RjtBQUd6RixvRkFBNEQ7QUFJNUQsK0NBQW9EO0FBVXBELFNBQVMsZUFBZSxDQUFDLEtBQWE7SUFDcEMsTUFBTSxFQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsR0FBRyxLQUFLLENBQUM7SUFDdkMsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNyQyxNQUFNLE9BQU8sR0FBRyxzQkFBUyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUMvQyxNQUFNLFNBQVMsR0FBRyxpQkFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxZQUFZLEVBQUUsV0FBVyxFQUFFLE9BQU8sQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNuRixNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsRUFBRTtRQUN6RCxNQUFNLE9BQU8sR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDL0IsS0FBSyxDQUFDLEdBQUcsQ0FBQyxtQ0FDTCxPQUFPLEtBQ1YsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLEdBQUcsQ0FBQyxHQUN4QixDQUFDO1FBQ0YsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDUCxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsb0JBQU8sQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRSxLQUFZLENBQUMsQ0FBQyxDQUFDO0lBQzNFLElBQUksV0FBVyxLQUFLLFNBQVMs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QUFXLEdBQUcsQ0FBQyxHQUN4QixDQUFDOzRCQUNGLE9BQU8sS0FBSyxDQUFDO3dCQUNmLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQzt3QkFFYixPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsb0JBQU8sQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRSxLQUFZLENBQUMsQ0FBQyxDQUFDO3dCQUMzRSxJQUFJLFdBQVcsS0FBSyxTQUFTLEVBQUU7NEJBQzdCLFdBQVcsRUFBRSxDQUFDO3lCQUNmO29CQUNILENBQUMsQ0FBQzt5QkFDRCxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUU7d0JBQ1gsTUFBTSxXQUFXLEdBQUcsQ0FBQyxDQUFDLEdBQUcsWUFBWSxpQkFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO3dCQUN0RCxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDLG9DQUFvQyxFQUFFLEdBQUcsRUFDekUsRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDO29CQUNyQixDQUFDLENBQUMsQ0FBQztnQkFDUCxDQUFDLEVBQUM7U0FDSCxDQUFDLENBQUM7SUFDTCxDQUFDLEVBQUUsR0FBRyxFQUFFO1FBQ04sTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDM0MsTUFBTSxRQUFRLEdBQUcsc0JBQVMsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDL0MsT0FBTyxRQUFRLEtBQUssZ0JBQU8sQ0FBQztJQUM5QixDQUFDLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQztBQWhKVyxRQUFBLGVBQWUsbUJBZ0oxQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgYWN0aW9ucywgZnMsIHNlbGVjdG9ycywgdHlwZXMsIHV0aWwgfSBmcm9tICd2b3J0ZXgtYXBpJztcblxuaW1wb3J0IHsgc2V0UHJpb3JpdHlUeXBlIH0gZnJvbSAnLi9hY3Rpb25zJztcbmltcG9ydCB7IEdBTUVfSUQsIGdldFByaW9yaXR5VHlwZUJyYW5jaCwgSTE4Tl9OQU1FU1BBQ0UsIExPQ0tFRF9QUkVGSVggfSBmcm9tICcuL2NvbW1vbic7XG5pbXBvcnQgeyBQcmlvcml0eU1hbmFnZXIsIFByaW9yaXR5VHlwZSB9IGZyb20gJy4vcHJpb3JpdHlNYW5hZ2VyJztcblxuaW1wb3J0IFByaW9yaXR5VHlwZUJ1dHRvbiBmcm9tICcuL3ZpZXdzL1ByaW9yaXR5VHlwZUJ1dHRvbic7XG5cbmltcG9ydCB7IGV4cG9ydE1lbnVNb2QsIGltcG9ydE1lbnVNb2QgfSBmcm9tICcuL21lbnVtb2QnO1xuXG5pbXBvcnQgeyBtYWtlT25Db250ZXh0SW1wb3J0IH0gZnJvbSAnLi9tZXJnZUJhY2t1cCc7XG5pbXBvcnQgeyBNb2RMaW1pdFBhdGNoZXIgfSBmcm9tICcuL21vZExpbWl0UGF0Y2gnO1xuXG5pbnRlcmZhY2UgSVByb3BzIHtcbiAgY29udGV4dDogdHlwZXMuSUV4dGVuc2lvbkNvbnRleHQ7XG4gIHJlZnJlc2hGdW5jOiAoKSA9PiB2b2lkO1xuICBnZXRQcmlvcml0eU1hbmFnZXI6ICgpID0+IFByaW9yaXR5TWFuYWdlcjtcbiAgZ2V0TW9kTGltaXRQYXRjaGVyOiAoKSA9PiBNb2RMaW1pdFBhdGNoZXI7XG59XG5cbmZ1bmN0aW9uIHJlc2V0UHJpb3JpdGllcyhwcm9wczogSVByb3BzKSB7XG4gIGNvbnN0IHsgY29udGV4dCwgcmVmcmVzaEZ1bmMgfSA9IHByb3BzO1xuICBjb25zdCBzdGF0ZSA9IGNvbnRleHQuYXBpLmdldFN0YXRlKCk7XG4gIGNvbnN0IHByb2ZpbGUgPSBzZWxlY3RvcnMuYWN0aXZlUHJvZmlsZShzdGF0ZSk7XG4gIGNvbnN0IGxvYWRPcmRlciA9IHV0aWwuZ2V0U2FmZShzdGF0ZSwgWydwZXJzaXN0ZW50JywgJ2xvYWRPcmRlcicsIHByb2ZpbGUuaWRdLCB7fSk7XG4gIGNvbnN0IG5ld0xPID0gT2JqZWN0LmtleXMobG9hZE9yZGVyKS5yZWR1Y2UoKGFjY3VtLCBrZXkpID0+IHtcbiAgICBjb25zdCBsb0VudHJ5ID0gbG9hZE9yZGVyW2tleV07XG4gICAgYWNjdW1ba2V5XSA9IHtcbiAgICAgIC4uLmxvRW50cnksXG4gICAgICBwcmVmaXg6IGxvRW50cnkucG9zICsgMSxcbiAgICB9O1xuICAgIHJldHVybiBhY2N1bTtcbiAgfSwge30pO1xuICBjb250ZXh0LmFwaS5zdG9yZS5kaXNwYXRjaChhY3Rpb25zLnNldExvYWRPcmRlcihwcm9maWxlLmlkLCBuZXdMTyBhcyBhbnkpKTtcbiAgaWYgKHJlZnJlc2hGdW5jICE9PSB1bmRlZmluZWQpIHtcbiAgICByZWZyZXNoRnVuYygpO1xuICB9XG4gIHJldHVybiBuZXdMTztcbn1cblxuZXhwb3J0IGNvbnN0IHJlZ2lzdGVyQWN0aW9ucyA9IChwcm9wczogSVByb3BzKSA9PiB7XG4gIGNvbnN0IHsgY29udGV4dCwgcmVmcmVzaEZ1bmMsIGdldE1vZExpbWl0UGF0Y2hlciB9ID0gcHJvcHM7XG4gIGNvbnN0IG9wZW5UVzNEb2NQYXRoID0gKCkgPT4ge1xuICAgIGNvbnN0IGRvY1BhdGggPSBwYXRoLmpvaW4odXRpbC5nZXRWb3J0ZXhQYXRoKCdkb2N1bWVudHMnKSwgJ1RoZSBXaXRjaGVyIDMnKTtcbiAgICB1dGlsLm9wbihkb2NQYXRoKS5jYXRjaCgoKSA9PiBudWxsKTtcbiAgfTtcblxuICBjb25zdCBpc1RXMyA9IChnYW1lSWQgPSB1bmRlZmluZWQpID0+IHtcbiAgICBpZiAoZ2FtZUlkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiAoZ2FtZUlkID09PSBHQU1FX0lEKTtcbiAgICB9XG4gICAgY29uc3Qgc3RhdGUgPSBjb250ZXh0LmFwaS5nZXRTdGF0ZSgpO1xuICAgIGNvbnN0IGdhbWVNb2RlID0gc2VsZWN0b3JzLmFjdGl2ZUdhbWVJZChzdGF0ZSk7XG4gICAgcmV0dXJuIChnYW1lTW9kZSA9PT0gR0FNRV9JRCk7XG4gIH07XG5cbiAgY29udGV4dC5yZWdpc3RlckFjdGlvbignbW9kcy1hY3Rpb24taWNvbnMnLCAzMDAsICdzdGFydC1pbnN0YWxsJywge30sICdJbXBvcnQgU2NyaXB0IE1lcmdlcycsXG4gICAgaW5zdGFuY2VJZHMgPT4geyBtYWtlT25Db250ZXh0SW1wb3J0KGNvbnRleHQsIGluc3RhbmNlSWRzWzBdKTsgfSxcbiAgICBpbnN0YW5jZUlkcyA9PiB7XG4gICAgICBjb25zdCBzdGF0ZSA9IGNvbnRleHQuYXBpLmdldFN0YXRlKCk7XG4gICAgICBjb25zdCBtb2RzID0gdXRpbC5nZXRTYWZlKHN0YXRlLCBbJ3BlcnNpc3RlbnQnLCAnbW9kcycsIEdBTUVfSURdLCB7fSk7XG4gICAgICBpZiAobW9kc1tpbnN0YW5jZUlkcz8uWzBdXT8udHlwZSAhPT0gJ2NvbGxlY3Rpb24nKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGFjdGl2ZUdhbWVJZCA9IHNlbGVjdG9ycy5hY3RpdmVHYW1lSWQoc3RhdGUpO1xuICAgICAgcmV0dXJuIGFjdGl2ZUdhbWVJZCA9PT0gR0FNRV9JRDtcbiAgICB9KTtcblxuICBjb250ZXh0LnJlZ2lzdGVyQWN0aW9uKCdtb2QtaWNvbnMnLCA1MDAsICdzYXZlZ2FtZScsIHt9LCAnQXBwbHkgTW9kIExpbWl0IFBhdGNoJywgKCkgPT4ge1xuICAgIGdldE1vZExpbWl0UGF0Y2hlcigpLmVuc3VyZU1vZExpbWl0UGF0Y2goKVxuICAgICAgLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIGNvbnRleHQuYXBpLnNob3dFcnJvck5vdGlmaWNhdGlvbignRmFpbGVkIHRvIGFwcGx5IHBhdGNoJywgZXJyLCB7XG4gICAgICAgICAgYWxsb3dSZXBvcnQ6IChlcnIgaW5zdGFuY2VvZiB1dGlsLlByb2Nlc3NDYW5jZWxlZCksXG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gIH0sICgpID0+IHNlbGVjdG9ycy5hY3RpdmVHYW1lSWQoY29udGV4dC5hcGkuZ2V0U3RhdGUoKSkgPT09IEdBTUVfSUQpO1xuXG4gIGNvbnRleHQucmVnaXN0ZXJBY3Rpb24oJ2dlbmVyaWMtbG9hZC1vcmRlci1pY29ucycsIDMwMCwgUHJpb3JpdHlUeXBlQnV0dG9uLCB7fSxcbiAgICB1bmRlZmluZWQsIGlzVFczKTtcblxuICBjb250ZXh0LnJlZ2lzdGVyQWN0aW9uKCdtb2QtaWNvbnMnLCAzMDAsICdvcGVuLWV4dCcsIHt9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICdPcGVuIFRXMyBEb2N1bWVudHMgRm9sZGVyJywgb3BlblRXM0RvY1BhdGgsIGlzVFczKTtcblxuICBjb250ZXh0LnJlZ2lzdGVyQWN0aW9uKCdnZW5lcmljLWxvYWQtb3JkZXItaWNvbnMnLCAzMDAsICdvcGVuLWV4dCcsIHt9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICdPcGVuIFRXMyBEb2N1bWVudHMgRm9sZGVyJywgb3BlblRXM0RvY1BhdGgsIGlzVFczKTtcblxuICBjb250ZXh0LnJlZ2lzdGVyQWN0aW9uKCdnZW5lcmljLWxvYWQtb3JkZXItaWNvbnMnLCAxMDAsICdsb290LXNvcnQnLCB7fSwgJ1Jlc2V0IFByaW9yaXRpZXMnLFxuICAgICgpID0+IHtcbiAgICAgIGNvbnRleHQuYXBpLnNob3dEaWFsb2coJ2luZm8nLCAnUmVzZXQgUHJpb3JpdGllcycsIHtcbiAgICAgICAgYmJjb2RlOiBjb250ZXh0LmFwaS50cmFuc2xhdGUoJ1RoaXMgYWN0aW9uIHdpbGwgcmV2ZXJ0IGFsbCBtYW51YWxseSBzZXQgcHJpb3JpdGllcyBhbmQgd2lsbCByZS1pbnN0YXRlIHByaW9yaXRpZXMgaW4gYW4gaW5jcmVtZW50YWwgJ1xuICAgICAgICAgICsgJ21hbm5lciBzdGFydGluZyBmcm9tIDEuIEFyZSB5b3Ugc3VyZSB5b3Ugd2FudCB0byBkbyB0aGlzID8nLCB7IG5zOiBJMThOX05BTUVTUEFDRSB9KSxcbiAgICAgIH0sIFtcbiAgICAgICAgeyBsYWJlbDogJ0NhbmNlbCcsIGFjdGlvbjogKCkgPT4ge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfX0sXG4gICAgICAgIHsgbGFiZWw6ICdSZXNldCBQcmlvcml0aWVzJywgYWN0aW9uOiAoKSA9PiByZXNldFByaW9yaXRpZXMocHJvcHMpIH0sXG4gICAgICBdKTtcbiAgICB9LCAoKSA9PiB7XG4gICAgICBjb25zdCBzdGF0ZSA9IGNvbnRleHQuYXBpLnN0b3JlLmdldFN0YXRlKCk7XG4gICAgICBjb25zdCBnYW1lTW9kZSA9IHNlbGVjdG9ycy5hY3RpdmVHYW1lSWQoc3RhdGUpO1xuICAgICAgcmV0dXJuIGdhbWVNb2RlID09PSBHQU1FX0lEO1xuICAgIH0pO1xuXG4gIGNvbnRleHQucmVnaXN0ZXJBY3Rpb24oJ2dlbmVyaWMtbG9hZC1vcmRlci1pY29ucycsIDEwMCwgJ2xvb3Qtc29ydCcsIHt9LCAnU29ydCBieSBEZXBsb3kgT3JkZXInLFxuICAgICgpID0+IHtcbiAgICAgIGNvbnRleHQuYXBpLnNob3dEaWFsb2coJ2luZm8nLCAnU29ydCBieSBEZXBsb3ltZW50IE9yZGVyJywge1xuICAgICAgICBiYmNvZGU6IGNvbnRleHQuYXBpLnRyYW5zbGF0ZSgnVGhpcyBhY3Rpb24gd2lsbCBzZXQgcHJpb3JpdGllcyB1c2luZyB0aGUgZGVwbG95bWVudCBydWxlcyAnXG4gICAgICAgICAgKyAnZGVmaW5lZCBpbiB0aGUgbW9kcyBwYWdlLiBBcmUgeW91IHN1cmUgeW91IHdpc2ggdG8gcHJvY2VlZCA/W2JyXVsvYnJdW2JyXVsvYnJdJ1xuICAgICAgICAgICsgJ1BsZWFzZSBiZSBhd2FyZSB0aGF0IGFueSBleHRlcm5hbGx5IGFkZGVkIG1vZHMgKGFkZGVkIG1hbnVhbGx5IG9yIGJ5IG90aGVyIHRvb2xzKSB3aWxsIGJlIHB1c2hlZCAnXG4gICAgICAgICAgKyAndG8gdGhlIGJvdHRvbSBvZiB0aGUgbGlzdCwgd2hpbGUgYWxsIG1vZHMgdGhhdCBoYXZlIGJlZW4gaW5zdGFsbGVkIHRocm91Z2ggVm9ydGV4IHdpbGwgc2hpZnQgJ1xuICAgICAgICAgICsgJ2luIHBvc2l0aW9uIHRvIG1hdGNoIHRoZSBkZXBsb3kgb3JkZXIhJywgeyBuczogSTE4Tl9OQU1FU1BBQ0UgfSksXG4gICAgICB9LCBbXG4gICAgICAgIHsgbGFiZWw6ICdDYW5jZWwnLCBhY3Rpb246ICgpID0+IHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH19LFxuICAgICAgICB7IGxhYmVsOiAnU29ydCBieSBEZXBsb3kgT3JkZXInLCBhY3Rpb246ICgpID0+IHtcbiAgICAgICAgICBjb25zdCBzdGF0ZSA9IGNvbnRleHQuYXBpLmdldFN0YXRlKCk7XG4gICAgICAgICAgY29uc3QgZ2FtZU1vZHMgPSBzdGF0ZS5wZXJzaXN0ZW50Lm1vZHNbR0FNRV9JRF0gfHwge307XG4gICAgICAgICAgY29uc3QgcHJvZmlsZSA9IHNlbGVjdG9ycy5hY3RpdmVQcm9maWxlKHN0YXRlKTtcbiAgICAgICAgICBjb25zdCBtb2RzID0gT2JqZWN0LmtleXMoZ2FtZU1vZHMpXG4gICAgICAgICAgICAuZmlsdGVyKGtleSA9PiB1dGlsLmdldFNhZmUocHJvZmlsZSwgWydtb2RTdGF0ZScsIGtleSwgJ2VuYWJsZWQnXSwgZmFsc2UpKVxuICAgICAgICAgICAgLm1hcChrZXkgPT4gZ2FtZU1vZHNba2V5XSk7XG4gICAgICAgICAgcmV0dXJuIHV0aWwuc29ydE1vZHMoR0FNRV9JRCwgbW9kcywgY29udGV4dC5hcGkpXG4gICAgICAgICAgICAudGhlbihzb3J0ZWQgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBsb2FkT3JkZXIgPSB1dGlsLmdldFNhZmUoc3RhdGUsIFsncGVyc2lzdGVudCcsICdsb2FkT3JkZXInLCBwcm9maWxlLmlkXSwge30pO1xuICAgICAgICAgICAgICBjb25zdCBmaWx0ZXJlZCA9IE9iamVjdC5rZXlzKGxvYWRPcmRlcikuZmlsdGVyKGtleSA9PlxuICAgICAgICAgICAgICAgIHNvcnRlZC5maW5kKG1vZCA9PiBtb2QuaWQgPT09IGtleSkgIT09IHVuZGVmaW5lZCk7XG4gICAgICAgICAgICAgIGNvbnN0IG1hbnVhbGx5QWRkZWQgPSBPYmplY3Qua2V5cyhsb2FkT3JkZXIpLmZpbHRlcihrZXkgPT4gIWZpbHRlcmVkLmluY2x1ZGVzKGtleSkpO1xuICAgICAgICAgICAgICBjb25zdCBtaW5pbXVtSWR4ID0gbWFudWFsbHlBZGRlZFxuICAgICAgICAgICAgICAgIC5maWx0ZXIoa2V5ID0+IGtleS5pbmNsdWRlcyhMT0NLRURfUFJFRklYKSlcbiAgICAgICAgICAgICAgICAucmVkdWNlKChtaW4sIGtleSkgPT4ge1xuICAgICAgICAgICAgICAgICAgaWYgKG1pbiA8PSBsb2FkT3JkZXJba2V5XS5wb3MpIHtcbiAgICAgICAgICAgICAgICAgICAgbWluID0gbG9hZE9yZGVyW2tleV0ucG9zICsgMTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIHJldHVybiBtaW47XG4gICAgICAgICAgICAgICAgfSwgMCk7XG4gICAgICAgICAgICAgIGNvbnN0IG1hbnVhbExPID0gbWFudWFsbHlBZGRlZC5yZWR1Y2UoKGFjY3VtLCBrZXksIGlkeCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChrZXkuaW5jbHVkZXMoTE9DS0VEX1BSRUZJWCkpIHtcbiAgICAgICAgICAgICAgICAgIGFjY3VtW2tleV0gPSBsb2FkT3JkZXJba2V5XTtcbiAgICAgICAgICAgICAgICAgIHJldHVybiBhY2N1bTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjb25zdCBtaW5pbXVtUG9zaXRpb24gPSAoZmlsdGVyZWQubGVuZ3RoICsgbWluaW11bUlkeCArIDEpO1xuICAgICAgICAgICAgICAgIGlmIChsb2FkT3JkZXJba2V5XS5wb3MgPCBtaW5pbXVtUG9zaXRpb24pIHtcbiAgICAgICAgICAgICAgICAgIGFjY3VtW2tleV0gPSB7XG4gICAgICAgICAgICAgICAgICAgIC4uLmxvYWRPcmRlcltrZXldLFxuICAgICAgICAgICAgICAgICAgICBwb3M6IGxvYWRPcmRlcltrZXldLnBvcyArIChtaW5pbXVtUG9zaXRpb24gKyBpZHgpLFxuICAgICAgICAgICAgICAgICAgICBwcmVmaXg6IGxvYWRPcmRlcltrZXldLnBvcyArIChtaW5pbXVtUG9zaXRpb24gKyBpZHggKyAxKSxcbiAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICByZXR1cm4gYWNjdW07XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgIGFjY3VtW2tleV0gPSBsb2FkT3JkZXJba2V5XTtcbiAgICAgICAgICAgICAgICAgIHJldHVybiBhY2N1bTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0sIHt9KTtcbiAgICAgICAgICAgICAgY29uc3QgbmV3TE8gPSBmaWx0ZXJlZC5yZWR1Y2UoKGFjY3VtLCBrZXkpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBsb0VudHJ5ID0gbG9hZE9yZGVyW2tleV07XG4gICAgICAgICAgICAgICAgY29uc3QgaWR4ID0gc29ydGVkLmZpbmRJbmRleChtb2QgPT4gbW9kLmlkID09PSBrZXkpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGFzc2lnbmVkSWR4ID0gbWluaW11bUlkeCArIGlkeDtcbiAgICAgICAgICAgICAgICBhY2N1bVtrZXldID0ge1xuICAgICAgICAgICAgICAgICAgLi4ubG9FbnRyeSxcbiAgICAgICAgICAgICAgICAgIHBvczogYXNzaWduZWRJZHgsXG4gICAgICAgICAgICAgICAgICBwcmVmaXg6IGFzc2lnbmVkSWR4ICsgMSxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIHJldHVybiBhY2N1bTtcbiAgICAgICAgICAgICAgfSwgbWFudWFsTE8pO1xuXG4gICAgICAgICAgICAgIGNvbnRleHQuYXBpLnN0b3JlLmRpc3BhdGNoKGFjdGlvbnMuc2V0TG9hZE9yZGVyKHByb2ZpbGUuaWQsIG5ld0xPIGFzIGFueSkpO1xuICAgICAgICAgICAgICBpZiAocmVmcmVzaEZ1bmMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIHJlZnJlc2hGdW5jKCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICAgICAgY29uc3QgYWxsb3dSZXBvcnQgPSAhKGVyciBpbnN0YW5jZW9mIHV0aWwuQ3ljbGVFcnJvcik7XG4gICAgICAgICAgICAgIGNvbnRleHQuYXBpLnNob3dFcnJvck5vdGlmaWNhdGlvbignRmFpbGVkIHRvIHNvcnQgYnkgZGVwbG95bWVudCBvcmRlcicsIGVycixcbiAgICAgICAgICAgICAgICB7IGFsbG93UmVwb3J0IH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH19LFxuICAgICAgXSk7XG4gICAgfSwgKCkgPT4ge1xuICAgICAgY29uc3Qgc3RhdGUgPSBjb250ZXh0LmFwaS5zdG9yZS5nZXRTdGF0ZSgpO1xuICAgICAgY29uc3QgZ2FtZU1vZGUgPSBzZWxlY3RvcnMuYWN0aXZlR2FtZUlkKHN0YXRlKTtcbiAgICAgIHJldHVybiBnYW1lTW9kZSA9PT0gR0FNRV9JRDtcbiAgICB9KTtcbn07XG4iXX0=